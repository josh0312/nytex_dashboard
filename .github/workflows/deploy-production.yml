name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual triggering
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'

env:
  PROJECT_ID: nytex-business-systems
  SERVICE_NAME: nytex-dashboard
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev
  REPOSITORY: nytex-dashboard
  
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run critical tests
        run: |
          python -m pytest tests/test_critical_endpoints.py -v -m "not slow"
          
      - name: Run deployment tests
        run: |
          python -m pytest tests/ -v -m "deployment" --tb=short
          
      - name: Run performance tests
        run: |
          python -m pytest tests/test_performance.py -v -m "not slow" --tb=short || echo "Performance tests had warnings"

      - name: Lint code
        run: |
          pip install flake8
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting completed with warnings"

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.force_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Python for migrations
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker ${GAR_LOCATION}

      - name: Build Docker image
        run: |
          docker build -t ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }} .
          docker build -t ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:latest .

      - name: Push Docker image
        run: |
          docker push ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }}
          docker push ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:latest

      - name: Verify secrets before deployment
        run: |
          echo "Verifying required secrets exist..."
          gcloud secrets versions access latest --secret="database-uri" > /dev/null && echo "‚úÖ database-uri exists" || echo "‚ùå database-uri missing"
          gcloud secrets versions access latest --secret="secret-key" > /dev/null && echo "‚úÖ secret-key exists" || echo "‚ùå secret-key missing"
          gcloud secrets versions access latest --secret="square-access-token" > /dev/null && echo "‚úÖ square-access-token exists" || echo "‚ùå square-access-token missing"

      - name: Run database migrations
        run: |
          echo "üîÑ Running database migrations..."
          
          # Get database URI from secrets and validate
          echo "üì° Retrieving database URI from secrets..."
          DATABASE_URI=$(gcloud secrets versions access latest --secret="database-uri")
          
          if [ -z "$DATABASE_URI" ]; then
            echo "‚ùå ERROR: Database URI is empty"
            exit 1
          fi
          
          echo "‚úÖ Database URI retrieved successfully"
          echo "üîç Database URI format check: $(echo $DATABASE_URI | grep -o '^[^:]*://[^@]*@[^/]*' || echo 'Invalid format')"
          
          # Convert Cloud SQL socket URI to external IP URI for CI/CD
          echo "üîÑ Converting socket URI to external IP URI for CI/CD access..."
          
          # Extract components from the socket URI
          DB_USER=$(echo $DATABASE_URI | sed -n 's|postgresql+asyncpg://\([^:]*\):.*|\1|p')
          DB_PASS=$(echo $DATABASE_URI | sed -n 's|postgresql+asyncpg://[^:]*:\([^@]*\)@.*|\1|p')
          DB_NAME=$(echo $DATABASE_URI | sed -n 's|.*@/\([^?]*\).*|\1|p')
          
          # Create external IP URI for migrations (CI/CD can't access Cloud SQL socket)
          MIGRATION_DATABASE_URI="postgresql://${DB_USER}:${DB_PASS}@34.28.125.188:5432/${DB_NAME}?sslmode=require"
          
          echo "üîç Migration will use external IP connection"
          echo "üìç Database user: $DB_USER"
          echo "üìç Database name: $DB_NAME"
          echo "üìç Connection method: External IP (for CI/CD compatibility)"
          
          # Verify we're connecting to the same database as the application
          echo "üîç Extracting database connection details (without credentials)..."
          DB_HOST=$(echo $DATABASE_URI | sed -n 's|.*@\([^/]*\)/.*|\1|p')
          DB_NAME=$(echo $DATABASE_URI | sed -n 's|.*/\([^?]*\).*|\1|p')
          echo "üìç Database host: $DB_HOST"
          echo "üìç Database name: $DB_NAME"
          
          # Install Python dependencies for migration
          echo "üì¶ Installing Python dependencies..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed"
          
          # Set environment variables for migration
          export SQLALCHEMY_DATABASE_URI="$MIGRATION_DATABASE_URI"
          export PYTHONPATH="${GITHUB_WORKSPACE}"
          
          # Test database connectivity before migration
          echo "üîå Testing database connectivity..."
          python3 -c "
          import os
          import psycopg2
          from urllib.parse import urlparse
          
          try:
              uri = os.environ['SQLALCHEMY_DATABASE_URI']
              print(f'üîó Testing connection to: {uri.split(\"@\")[1] if \"@\" in uri else \"unknown\"}')
              
              conn = psycopg2.connect(uri)
              cursor = conn.cursor()
              cursor.execute('SELECT version()')
              result = cursor.fetchone()[0]
              cursor.close()
              conn.close()
              
              print(f'‚úÖ Database connection successful')
              print(f'üìä PostgreSQL version: {result[:50]}...')
          except Exception as e:
              print(f'‚ùå Database connection failed: {e}')
              exit(1)
          "
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Database connectivity test failed, aborting migration"
            exit 1
          fi
          
          # Check current migration status
          echo "üìã Checking current migration status..."
          python3 -c "
          import os
          import psycopg2
          from urllib.parse import urlparse
          
          try:
              uri = os.environ['SQLALCHEMY_DATABASE_URI']
              
              conn = psycopg2.connect(uri)
              cursor = conn.cursor()
              
              # Check if alembic_version table exists
              cursor.execute(\"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'alembic_version')\")
              table_exists = cursor.fetchone()[0]
              
              if table_exists:
                  cursor.execute('SELECT version_num FROM alembic_version')
                  current_rev = cursor.fetchone()[0]
                  print(f'üìå Current migration revision: {current_rev}')
              else:
                  print('üìå No migration history found (fresh database)')
              
              # Check if items_view exists
              cursor.execute(\"SELECT EXISTS (SELECT FROM information_schema.views WHERE table_name = 'items_view')\")
              view_exists = cursor.fetchone()[0]
              print(f'üîç items_view exists: {view_exists}')
              
              cursor.close()
              conn.close()
          except Exception as e:
              print(f'‚ùå Migration status check failed: {e}')
          "
          
          # Run Alembic migrations with detailed output
          echo "üöÄ Running Alembic migrations..."
          echo "üìÇ Current directory: $(pwd)"
          echo "üìÅ Migrations directory contents:"
          ls -la migrations/
          echo "üìÑ Alembic config check:"
          cat migrations/alembic.ini | grep -A 5 -B 5 script_location
          
          echo "üîß Running alembic upgrade head..."
          alembic -c migrations/alembic.ini upgrade head --verbose
          
          MIGRATION_EXIT_CODE=$?
          echo "üìä Migration exit code: $MIGRATION_EXIT_CODE"
          
          if [ $MIGRATION_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Migration failed with exit code $MIGRATION_EXIT_CODE"
            exit 1
          fi
          
          # Verify migration success
          echo "‚úÖ Verifying migration success..."
          python3 -c "
          import os
          import psycopg2
          from urllib.parse import urlparse
          
          try:
              uri = os.environ['SQLALCHEMY_DATABASE_URI']
              
              conn = psycopg2.connect(uri)
              cursor = conn.cursor()
              
              # Check final migration revision
              cursor.execute('SELECT version_num FROM alembic_version')
              current_rev = cursor.fetchone()[0]
              print(f'üìå Final migration revision: {current_rev}')
              
              # Verify items_view was created
              cursor.execute(\"SELECT EXISTS (SELECT FROM information_schema.views WHERE table_name = 'items_view')\")
              view_exists = cursor.fetchone()[0]
              print(f'üîç items_view created successfully: {view_exists}')
              
              if view_exists:
                  # Test the view
                  cursor.execute('SELECT COUNT(*) FROM items_view')
                  count = cursor.fetchone()[0]
                  print(f'üìä items_view contains {count} items')
              
              cursor.close()
              conn.close()
              exit(0 if view_exists else 1)
          except Exception as e:
              print(f'‚ùå Migration verification failed: {e}')
              exit(1)
          "
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Database migrations completed successfully"
          else
            echo "‚ùå Migration verification failed"
            exit 1
          fi

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${SERVICE_NAME} \
            --image ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }} \
            --platform managed \
            --region ${REGION} \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --timeout 300 \
            --concurrency 80 \
            --add-cloudsql-instances ${PROJECT_ID}:${REGION}:nytex-main-db \
            --set-env-vars "CLOUD_SQL_CONNECTION_NAME=${PROJECT_ID}:${REGION}:nytex-main-db" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${PROJECT_ID}" \
            --set-env-vars "DEBUG=false" \
            --set-env-vars "SQLALCHEMY_ECHO=false" \
            --set-env-vars "ENVIRONMENT=production" \
            --set-env-vars "SQUARE_CATALOG_EXPORT_URL=https://square-catalog-export-932676587025.us-central1.run.app" \
            --update-secrets "SECRET_KEY=secret-key:latest" \
            --update-secrets "SQLALCHEMY_DATABASE_URI=database-uri:latest" \
            --update-secrets "SQUARE_ACCESS_TOKEN=square-access-token:latest" \
            --update-secrets "SQUARE_ENVIRONMENT=square-environment:latest" \
            --update-secrets "OPENWEATHER_API_KEY=openweather-api-key:latest" \
            --update-secrets "MANUAL_USER_EMAIL=manual-user-email:latest" \
            --update-secrets "MANUAL_USER_PASSWORD=manual-user-password:latest" \
            --update-secrets "MANUAL_USER_NAME=manual-user-name:latest" \
            --update-secrets "AZURE_CLIENT_ID=azure-client-id:latest" \
            --update-secrets "AZURE_CLIENT_SECRET=azure-client-secret:latest" \
            --update-secrets "AZURE_TENANT_ID=azure-tenant-id:latest" \
            --update-secrets "AZURE_REDIRECT_URI=azure-redirect-uri:latest" \
            --update-secrets "SMTP_USERNAME=smtp-username:latest" \
            --update-secrets "SMTP_PASSWORD=smtp-password:latest" \
            --update-secrets "SMTP_SENDER_EMAIL=smtp-sender-email:latest" \
            --update-secrets "SYNC_NOTIFICATION_RECIPIENTS=sync-notification-recipients:latest"

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30

      - name: Switch traffic to new revision
        run: |
          NEW_REVISION=$(gcloud run revisions list --service=${SERVICE_NAME} --region=${REGION} --format='value(metadata.name)' --limit=1)
          echo "Switching traffic to new revision: $NEW_REVISION"
          gcloud run services update-traffic ${SERVICE_NAME} --region=${REGION} --to-revisions=${NEW_REVISION}=100
          
          # Wait for traffic to switch
          sleep 10

      - name: Health check
        run: |
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format='value(status.url)')
          echo "Service URL: $SERVICE_URL"
          
          # Test basic connectivity
          for i in {1..5}; do
            if curl -f -s "${SERVICE_URL}/admin/status" > /dev/null; then
              echo "‚úÖ Health check passed on attempt $i"
              break
            else
              echo "‚ùå Health check failed on attempt $i, retrying..."
              sleep 10
            fi
          done
          
          # Test database connectivity
          DB_STATUS=$(curl -s "${SERVICE_URL}/admin/status" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('database', 'unknown'))" 2>/dev/null || echo "error")
          if [ "$DB_STATUS" == "connected" ]; then
            echo "‚úÖ Database connection verified"
          else
            echo "‚ùå Database connection failed: $DB_STATUS"
            echo "Deployment completed but with database issues"
          fi
          
          # Test items API specifically (for items_view migration)
          echo "üîç Testing items API after migration..."
          sleep 5  # Give the service a moment after deployment
          
          ITEMS_TEST=$(curl -s "${SERVICE_URL}/items/data" | python3 -c "
          import sys, json
          try:
              data = json.load(sys.stdin)
              if 'error' in data:
                  print('error: ' + data['error'][:100] + '...')
              elif 'data' in data and isinstance(data['data'], list):
                  print('success: ' + str(len(data['data'])) + ' items')
              else:
                  print('unknown: unexpected response format')
          except:
              print('error: invalid json response')
          " 2>/dev/null)
          
          if [[ "$ITEMS_TEST" == success* ]]; then
            echo "‚úÖ Items API working: $ITEMS_TEST"
          else
            echo "‚ùå Items API failed: $ITEMS_TEST"
            echo "This may indicate the database migration didn't complete properly"
          fi

      - name: Verify traffic routing
        run: |
          NEW_REVISION=$(gcloud run revisions list --service=${SERVICE_NAME} --region=${REGION} --format='value(metadata.name)' --limit=1)
          ACTIVE_REVISION=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format='value(status.traffic[0].revisionName)')
          
          echo "New revision: $NEW_REVISION"
          echo "Active revision: $ACTIVE_REVISION"
          
          if [ "$NEW_REVISION" == "$ACTIVE_REVISION" ]; then
            echo "‚úÖ Traffic successfully routed to new revision"
          else
            echo "‚ùå Traffic routing failed. Expected: $NEW_REVISION, Active: $ACTIVE_REVISION"
            echo "Attempting to fix traffic routing..."
            gcloud run services update-traffic ${SERVICE_NAME} --region=${REGION} --to-revisions=${NEW_REVISION}=100
            sleep 5
            
            # Verify again
            ACTIVE_REVISION_RETRY=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format='value(status.traffic[0].revisionName)')
            if [ "$NEW_REVISION" == "$ACTIVE_REVISION_RETRY" ]; then
              echo "‚úÖ Traffic routing fixed on retry"
            else
              echo "‚ùå Traffic routing still failed after retry"
              exit 1
            fi
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, checking for previous version..."
          PREVIOUS_VERSION=$(gcloud run revisions list --service=${SERVICE_NAME} --region=${REGION} --format='value(metadata.name)' --limit=2 | tail -n1)
          if [ ! -z "$PREVIOUS_VERSION" ]; then
            echo "Rolling back to: $PREVIOUS_VERSION"
            gcloud run services update-traffic ${SERVICE_NAME} --region=${REGION} --to-revisions=${PREVIOUS_VERSION}=100
          fi

      - name: Cleanup old revisions
        if: success()
        run: |
          echo "Cleaning up old revisions (keeping latest 5)..."
          OLD_REVISIONS=$(gcloud run revisions list --service=${SERVICE_NAME} --region=${REGION} --format='value(metadata.name)' | tail -n +6)
          if [ ! -z "$OLD_REVISIONS" ]; then
            echo "Deleting old revisions: $OLD_REVISIONS"
            echo "$OLD_REVISIONS" | xargs -I {} gcloud run revisions delete {} --region=${REGION} --quiet || echo "Some revisions couldn't be deleted (may be in use)"
          else
            echo "No old revisions to clean up"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format='value(status.url)')
          ACTIVE_REVISION=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format='value(status.traffic[0].revisionName)')
          echo "üéâ Deployment Summary"
          echo "===================="
          echo "Service URL: $SERVICE_URL"
          echo "Active Revision: $ACTIVE_REVISION"
          echo "Image: ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "üîç Next Steps:"
          echo "1. Test the application: $SERVICE_URL"
          echo "2. Check admin status: $SERVICE_URL/admin/status"
          echo "3. Monitor logs: gcloud run services logs read ${SERVICE_NAME} --region ${REGION}" 