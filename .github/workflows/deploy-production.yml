name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual triggering
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'

env:
  PROJECT_ID: nytex-business-systems
  SERVICE_NAME: nytex-dashboard
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev
  REPOSITORY: nytex-dashboard
  
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m pytest tests/ -v || echo "Tests failed but continuing..."

      - name: Lint code
        run: |
          pip install flake8
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Linting completed with warnings"

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.force_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker ${GAR_LOCATION}

      - name: Build Docker image
        run: |
          docker build -t ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }} .
          docker build -t ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:latest .

      - name: Push Docker image
        run: |
          docker push ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }}
          docker push ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:latest

      - name: Verify secrets before deployment
        run: |
          echo "Verifying required secrets exist..."
          gcloud secrets versions access latest --secret="database-uri" > /dev/null && echo "‚úÖ database-uri exists" || echo "‚ùå database-uri missing"
          gcloud secrets versions access latest --secret="secret-key" > /dev/null && echo "‚úÖ secret-key exists" || echo "‚ùå secret-key missing"
          gcloud secrets versions access latest --secret="square-access-token" > /dev/null && echo "‚úÖ square-access-token exists" || echo "‚ùå square-access-token missing"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${SERVICE_NAME} \
            --image ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }} \
            --platform managed \
            --region ${REGION} \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --max-instances 10 \
            --min-instances 0 \
            --timeout 300 \
            --concurrency 80 \
            --add-cloudsql-instances ${PROJECT_ID}:${REGION}:nytex-main-db \
            --set-env-vars "CLOUD_SQL_CONNECTION_NAME=${PROJECT_ID}:${REGION}:nytex-main-db" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${PROJECT_ID}" \
            --set-env-vars "DEBUG=false" \
            --set-env-vars "SQLALCHEMY_ECHO=false" \
            --set-env-vars "ENVIRONMENT=production" \
            --set-env-vars "SQUARE_CATALOG_EXPORT_URL=https://square-catalog-export-932676587025.us-central1.run.app" \
            --update-secrets "SECRET_KEY=secret-key:latest" \
            --update-secrets "SQLALCHEMY_DATABASE_URI=database-uri:latest" \
            --update-secrets "SQUARE_ACCESS_TOKEN=square-access-token:latest" \
            --update-secrets "SQUARE_ENVIRONMENT=square-environment:latest" \
            --update-secrets "OPENWEATHER_API_KEY=openweather-api-key:latest" \
            --update-secrets "MANUAL_USER_EMAIL=manual-user-email:latest" \
            --update-secrets "MANUAL_USER_PASSWORD=manual-user-password:latest" \
            --update-secrets "MANUAL_USER_NAME=manual-user-name:latest" \
            --update-secrets "AZURE_CLIENT_ID=azure-client-id:latest" \
            --update-secrets "AZURE_CLIENT_SECRET=azure-client-secret:latest" \
            --update-secrets "AZURE_TENANT_ID=azure-tenant-id:latest" \
            --update-secrets "AZURE_REDIRECT_URI=azure-redirect-uri:latest" \
            --update-secrets "SMTP_USERNAME=smtp-username:latest" \
            --update-secrets "SMTP_PASSWORD=smtp-password:latest" \
            --update-secrets "SMTP_SENDER_EMAIL=smtp-sender-email:latest" \
            --update-secrets "SYNC_NOTIFICATION_RECIPIENTS=sync-notification-recipients:latest"

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30

      - name: Health check
        run: |
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format='value(status.url)')
          echo "Service URL: $SERVICE_URL"
          
          # Test basic connectivity
          for i in {1..5}; do
            if curl -f -s "${SERVICE_URL}/admin/status" > /dev/null; then
              echo "‚úÖ Health check passed on attempt $i"
              break
            else
              echo "‚ùå Health check failed on attempt $i, retrying..."
              sleep 10
            fi
          done
          
          # Test database connectivity
          DB_STATUS=$(curl -s "${SERVICE_URL}/admin/status" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('database', 'unknown'))" 2>/dev/null || echo "error")
          if [ "$DB_STATUS" == "connected" ]; then
            echo "‚úÖ Database connection verified"
          else
            echo "‚ùå Database connection failed: $DB_STATUS"
            echo "Deployment completed but with database issues"
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, checking for previous version..."
          PREVIOUS_VERSION=$(gcloud run revisions list --service=${SERVICE_NAME} --region=${REGION} --format='value(metadata.name)' --limit=2 | tail -n1)
          if [ ! -z "$PREVIOUS_VERSION" ]; then
            echo "Rolling back to: $PREVIOUS_VERSION"
            gcloud run services update-traffic ${SERVICE_NAME} --region=${REGION} --to-revisions=${PREVIOUS_VERSION}=100
          fi

      - name: Deployment Summary
        if: always()
        run: |
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} --region=${REGION} --format='value(status.url)')
          echo "üéâ Deployment Summary"
          echo "===================="
          echo "Service URL: $SERVICE_URL"
          echo "Image: ${GAR_LOCATION}/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${{ github.sha }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "üîç Next Steps:"
          echo "1. Test the application: $SERVICE_URL"
          echo "2. Check admin status: $SERVICE_URL/admin/status"
          echo "3. Monitor logs: gcloud run services logs read ${SERVICE_NAME} --region ${REGION}" 