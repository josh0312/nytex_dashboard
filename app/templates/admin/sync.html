{% extends "base.html" %}

{% block title %}Data Sync Administration{% endblock %}

{% block head %}
<style>
    .sync-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 24px;
        margin-bottom: 20px;
    }
    
    .sync-btn {
        background: #4F46E5;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .sync-btn:hover {
        background: #4338CA;
    }
    
    .sync-btn:disabled {
        background: #9CA3AF;
        cursor: not-allowed;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-ready { background: #10B981; }
    .status-running { background: #F59E0B; animation: pulse 2s infinite; }
    .status-error { background: #EF4444; }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .log-output {
        background: #1F2937;
        color: #F9FAFB;
        padding: 16px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 14px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 16px;
        white-space: pre-wrap;
    }
    
    .hidden { display: none; }
    
    /* Enhanced Visual Elements */
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #E5E7EB;
        border-radius: 4px;
        overflow: hidden;
        margin: 8px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10B981, #059669);
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
    }
    
    .sync-flow-step {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: 8px 0;
        border-radius: 8px;
        border: 2px solid #E5E7EB;
        background: #F9FAFB;
        transition: all 0.3s ease;
    }
    
    .sync-flow-step.active {
        border-color: #F59E0B;
        background: #FFFBEB;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }
    
    .sync-flow-step.completed {
        border-color: #10B981;
        background: #F0FDF4;
    }
    
    .sync-flow-step.error {
        border-color: #EF4444;
        background: #FEF2F2;
    }
    
    .step-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-weight: bold;
        color: white;
    }
    
    .step-icon.pending { background: #9CA3AF; }
    .step-icon.active { background: #F59E0B; animation: pulse 2s infinite; }
    .step-icon.completed { background: #10B981; }
    .step-icon.error { background: #EF4444; }
    
    .status-card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #E5E7EB;
        transition: all 0.2s ease;
    }
    
    .status-card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .status-card.ready {
        border-color: #10B981;
        background: linear-gradient(135deg, #F0FDF4, #ECFDF5);
    }
    
    .status-card.error {
        border-color: #EF4444;
        background: linear-gradient(135deg, #FEF2F2, #FDE8E8);
    }
    
    .status-card.warning {
        border-color: #F59E0B;
        background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
    }
    
    .metric-card {
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-color), var(--accent-color-dark));
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .metric-number {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1;
        margin: 8px 0;
    }
    
    .metric-label {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .metric-subtitle {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 4px;
    }
    
    .sync-timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .sync-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #E5E7EB;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #9CA3AF;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #E5E7EB;
    }
    
    .timeline-item.active::before {
        background: #F59E0B;
        box-shadow: 0 0 0 2px #F59E0B, 0 0 0 6px rgba(245, 158, 11, 0.2);
        animation: pulse 2s infinite;
    }
    
    .timeline-item.completed::before {
        background: #10B981;
        box-shadow: 0 0 0 2px #10B981;
    }
    
    .timeline-item.error::before {
        background: #EF4444;
        box-shadow: 0 0 0 2px #EF4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Data Sync Administration</h1>
                <p class="text-gray-600 mt-2">Sync data from Square to populate your production database</p>
            </div>
            <a href="/" class="text-blue-600 hover:text-blue-800">‚Üê Back to Dashboard</a>
        </div>

        <!-- Configuration Check -->
        <div class="sync-card">
            <h2 class="text-xl font-semibold mb-4">üîß Sync Readiness Check</h2>
            <p class="text-gray-600 mb-4">
                Comprehensive validation of all components required for successful production sync.
            </p>
            
            <!-- Overall Readiness Progress -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">System Readiness</span>
                    <span class="text-sm text-gray-500" id="readiness-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="readiness-progress"></div>
                </div>
            </div>
            
            <div id="config-status">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Database Status -->
                    <div class="status-card" id="db-card">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <span class="text-xl">üóÑÔ∏è</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-sm" id="db-text">Checking database...</div>
                                <div class="text-xs text-gray-500" id="db-detail">Validating connection...</div>
                            </div>
                            <span class="status-indicator" id="db-status"></span>
                        </div>
                    </div>
                    
                    <!-- Square API Status -->
                    <div class="status-card" id="square-card">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <span class="text-xl">üîó</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-sm" id="square-text">Checking Square API...</div>
                                <div class="text-xs text-gray-500" id="square-detail">Validating token...</div>
                            </div>
                            <span class="status-indicator" id="square-status"></span>
                        </div>
                    </div>
                    
                    <!-- Tables Status -->
                    <div class="status-card" id="tables-card">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <span class="text-xl">üìã</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-sm" id="tables-text">Checking tables...</div>
                                <div class="text-xs text-gray-500" id="tables-detail">Validating schema...</div>
                            </div>
                            <span class="status-indicator" id="tables-status"></span>
                        </div>
                    </div>
                    
                    <!-- Overall Readiness -->
                    <div class="status-card" id="overall-card">
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <span class="text-xl">‚ö°</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-sm" id="overall-text">Calculating readiness...</div>
                                <div class="text-xs text-gray-500" id="overall-detail">Analyzing components...</div>
                            </div>
                            <span class="status-indicator" id="overall-status"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Readiness Summary -->
                <div id="readiness-summary" class="mt-4 p-3 rounded border hidden">
                    <!-- Summary content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Complete Sync -->
        <div class="sync-card" style="border: 2px solid #10B981; background: linear-gradient(135deg, #F0FDF4 0%, #ECFDF5 100%);">
            <h2 class="text-xl font-semibold mb-4">üöÄ Complete Production Sync</h2>
            <p class="text-gray-700 mb-4">
                <strong>Recommended:</strong> Run this comprehensive sync to ensure production has all necessary data.
                This syncs locations, catalog data, and inventory in the proper order with advanced features.
            </p>
            
            <!-- Sync Flow Visualization -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">üìã Sync Process Flow</h3>
                <div class="sync-timeline" id="sync-timeline">
                    <div class="timeline-item" id="step-1">
                        <div class="flex items-center">
                            <div class="step-icon pending">1</div>
                            <div class="flex-1">
                                <div class="font-medium">üìç Sync Locations</div>
                                <div class="text-sm text-gray-600">Import all Square locations and store configurations</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item" id="step-2">
                        <div class="flex items-center">
                            <div class="step-icon pending">2</div>
                            <div class="flex-1">
                                <div class="font-medium">üìÇ Sync Catalog Data</div>
                                <div class="text-sm text-gray-600">Import categories, items, and variations with metadata</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item" id="step-3">
                        <div class="flex items-center">
                            <div class="step-icon pending">3</div>
                            <div class="flex-1">
                                <div class="font-medium">üì¶ Enhanced Inventory Sync</div>
                                <div class="text-sm text-gray-600">Import quantities with Units Per Case extraction and deduplication</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item" id="step-4">
                        <div class="flex items-center">
                            <div class="step-icon pending">4</div>
                            <div class="flex-1">
                                <div class="font-medium">üè™ Vendor Sync</div>
                                <div class="text-sm text-gray-600">Import vendor information and catalog associations</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Features Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white bg-opacity-60 p-4 rounded-lg border border-green-200">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üìã</div>
                        <div class="font-semibold text-sm">Units Per Case</div>
                        <div class="text-xs text-gray-600">Auto-extract custom attributes</div>
                    </div>
                </div>
                <div class="bg-white bg-opacity-60 p-4 rounded-lg border border-green-200">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîÑ</div>
                        <div class="font-semibold text-sm">Smart Deduplication</div>
                        <div class="text-xs text-gray-600">Handle multiple timestamps</div>
                    </div>
                </div>
                <div class="bg-white bg-opacity-60 p-4 rounded-lg border border-green-200">
                    <div class="text-center">
                        <div class="text-2xl mb-2">üîó</div>
                        <div class="font-semibold text-sm">Catalog Updates</div>
                        <div class="text-xs text-gray-600">Sync metadata during inventory</div>
                    </div>
                </div>
            </div>
            
            <!-- Sync Modes -->
            <div class="mb-4">
                <h4 class="font-semibold mb-2">üéõÔ∏è Sync Modes:</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex items-center p-3 bg-white bg-opacity-60 rounded border border-green-200">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-green-600 font-bold">üìà</span>
                        </div>
                        <div>
                            <div class="font-medium text-sm">Incremental (Default)</div>
                            <div class="text-xs text-gray-600">Safe updates - only changed data</div>
                        </div>
                    </div>
                    <div class="flex items-center p-3 bg-white bg-opacity-60 rounded border border-yellow-200">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-yellow-600 font-bold">üî•</span>
                        </div>
                        <div>
                            <div class="font-medium text-sm">Full Refresh</div>
                            <div class="text-xs text-gray-600">Complete rebuild - use with caution</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Full Refresh Option -->
            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <label class="flex items-center">
                    <input type="checkbox" id="full-refresh-checkbox" class="mr-2">
                    <span class="text-sm font-medium text-yellow-800">
                        üî• Full Refresh Mode (‚ö†Ô∏è Destructive - wipes all existing data)
                    </span>
                </label>
                <p class="text-xs text-yellow-700 mt-1">
                    Only check this if you need to completely rebuild the database from scratch.
                    Normal operation should use incremental mode.
                </p>
            </div>
            
            <div class="flex items-center gap-4">
                <button id="complete-sync-btn" class="sync-btn" style="background: #10B981; font-size: 16px; padding: 16px 32px;" onclick="runCompleteSync()">
                    <span id="complete-btn-text">üöÄ Start Incremental Sync</span>
                </button>
                <div id="complete-status" class="flex items-center">
                    <span class="status-indicator status-ready"></span>
                    <span>Ready to sync (incremental mode)</span>
                </div>
            </div>
            <div id="complete-log" class="log-output hidden"></div>
        </div>

        <!-- System Status -->
        <div class="sync-card">
            <h2 class="text-xl font-semibold mb-4">üìä Production Database Status</h2>
            <p class="text-gray-600 mb-4">
                Real-time view of your production database contents from the Complete Production Sync system.
                This shows actual data counts from your catalog items, variations, and inventory tables.
            </p>
            <div id="data-status">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-3 text-gray-600">Loading current database status...</span>
                </div>
            </div>
            <div class="flex items-center gap-3 mt-4">
                <button onclick="refreshDataStatus()" class="sync-btn">
                    üîÑ Refresh Status
                </button>
                <div class="text-xs text-gray-500" id="status-last-updated">
                    <!-- Last updated timestamp will appear here -->
                </div>
            </div>
        </div>

        <!-- Admin Tools & Monitoring -->
        <div class="sync-card">
            <h2 class="text-xl font-semibold mb-4">üõ†Ô∏è Admin Tools & Monitoring</h2>
            <p class="text-gray-600 mb-4">
                Essential admin tools and log monitoring for production sync management.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Log Viewer -->
                <div class="space-y-2">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">üìú Log Viewer</h3>
                    <button onclick="toggleLogViewer()" class="sync-btn w-full text-sm" id="log-viewer-btn">
                        üìñ Show Recent Logs
                    </button>
                    <button onclick="refreshLogs()" class="sync-btn w-full text-sm">
                        üîÑ Refresh Logs
                    </button>
                    <button onclick="downloadLogs()" class="sync-btn w-full text-sm">
                        üíæ Download Logs
                    </button>
                </div>
                
                <!-- Admin Tools -->
                <div class="space-y-2">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">üîß Admin Tools</h3>
                    <button onclick="toggleConfigDetails()" class="sync-btn w-full text-sm" id="config-details-btn">
                        ‚öôÔ∏è Show Config Details
                    </button>
                    <button onclick="toggleDatabaseStatus()" class="sync-btn w-full text-sm" id="database-status-btn">
                        üìã Show Database Status
                    </button>
                    <button onclick="toggleSystemHealth()" class="sync-btn w-full text-sm" id="system-health-btn">
                        üíö Show System Health
                    </button>
                </div>
            </div>
            
            <!-- Log Viewer Display -->
            <div id="log-viewer" class="mt-4 hidden">
                <div class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm max-h-96 overflow-y-auto">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-green-300 font-semibold">üìú Production Logs</span>
                        <span class="text-gray-400 text-xs" id="log-timestamp">Loading...</span>
                    </div>
                    <div id="log-content" class="whitespace-pre-wrap">
                        Click "Show Recent Logs" to load log entries...
                    </div>
                </div>
            </div>

            <!-- Quick Status Display -->
            <div id="quick-status" class="mt-4 p-3 bg-gray-50 rounded hidden">
                <!-- Dynamic status content will be loaded here -->
            </div>
        </div>

        <!-- Historical Orders Sync -->
        <div class="sync-card" style="border: 2px solid #EF4444; background: linear-gradient(135deg, #FEF2F2 0%, #FDE8E8 100%);">
            <h2 class="text-xl font-semibold mb-4">üìÖ Historical Orders Sync (2018-Present)</h2>
            <p class="text-gray-700 mb-4">
                <strong>Important:</strong> This will sync ALL historical orders from January 2018 to present.
                This is required for the annual sales comparison chart to work properly in production.
                <strong>This is a one-time process that may take several hours.</strong>
            </p>
            
            <!-- Warning Box -->
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                <div class="flex items-start">
                    <div class="text-yellow-600 mr-3">‚ö†Ô∏è</div>
                    <div>
                        <div class="font-semibold text-yellow-800 mb-1">Large Data Operation</div>
                        <div class="text-sm text-yellow-700">
                            ‚Ä¢ This will fetch ~7 years of order data from Square API<br>
                            ‚Ä¢ Expected to take 2-4 hours depending on order volume<br>
                            ‚Ä¢ Processes data in 30-day chunks with rate limiting<br>
                            ‚Ä¢ Can be resumed if interrupted<br>
                            ‚Ä¢ Uses upsert so safe to re-run
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Display -->
            <div id="historical-sync-progress" class="mb-4 hidden">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Historical Sync Progress</span>
                    <span class="text-sm text-gray-500" id="historical-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="historical-progress-bar"></div>
                </div>
                <div class="text-xs text-gray-600 mt-1" id="historical-details">Preparing to sync...</div>
            </div>
            
            <div class="flex items-center gap-4">
                <button id="historical-sync-btn" class="sync-btn" style="background: #EF4444; font-size: 16px; padding: 16px 32px;" onclick="runHistoricalOrdersSync()">
                    <span id="historical-btn-text">üìÖ Start Historical Orders Sync</span>
                </button>
                <div id="historical-status" class="flex items-center">
                    <span class="status-indicator status-ready"></span>
                    <span>Ready to sync 2018-present orders</span>
                </div>
            </div>
            <div id="historical-log" class="log-output hidden"></div>
        </div>

        <!-- Database Migration Section -->
        <div class="sync-card" style="border: 2px solid #F59E0B; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);">
            <h2 class="text-xl font-semibold mb-4">üîß Database Migration</h2>
            <p class="text-gray-700 mb-4">
                <strong>Production Fix:</strong> Add missing columns to order_line_items table for full Square API support.
                This migration adds <code>variation_total_price_money</code> and <code>item_variation_metadata</code> columns.
            </p>
            
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                <div class="flex items-start">
                    <div class="text-yellow-600 mr-3">‚ö†Ô∏è</div>
                    <div>
                        <div class="font-semibold text-yellow-800 mb-1">Schema Update Required</div>
                        <div class="text-sm text-yellow-700">
                            ‚Ä¢ Safe operation using ADD COLUMN IF NOT EXISTS<br>
                            ‚Ä¢ Required for historical orders sync to work properly<br>
                            ‚Ä¢ Will not affect existing data<br>
                            ‚Ä¢ Can be run multiple times safely
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button id="migration-btn" class="sync-btn" style="background: #F59E0B; font-size: 16px; padding: 16px 32px;" onclick="runDatabaseMigration()">
                    <span id="migration-btn-text">üîß Run Database Migration</span>
                </button>
                <div id="migration-status" class="flex items-center">
                    <span class="status-indicator status-ready"></span>
                    <span>Ready to add missing columns</span>
                </div>
            </div>
            <div id="migration-log" class="log-output hidden"></div>
        </div>

        <!-- End of Historical Orders Sync Section -->
    </div>
</div>

<script>
let syncInProgress = false;

// Check configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    checkSyncReadiness();
    refreshDataStatus();
    
    // Handle full refresh checkbox changes
    const fullRefreshCheckbox = document.getElementById('full-refresh-checkbox');
    const completeBtnText = document.getElementById('complete-btn-text');
    const completeStatus = document.getElementById('complete-status');
    
    fullRefreshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            completeBtnText.textContent = 'üî• Start Full Refresh Sync';
            completeStatus.innerHTML = '<span class="status-indicator status-ready"></span><span>Ready to sync (‚ö†Ô∏è FULL REFRESH mode)</span>';
        } else {
            completeBtnText.textContent = 'üöÄ Start Incremental Sync';
            completeStatus.innerHTML = '<span class="status-indicator status-ready"></span><span>Ready to sync (incremental mode)</span>';
        }
    });
});

async function checkSyncReadiness() {
    // Initialize all status indicators to loading state
    const statusElements = ['db', 'square', 'tables', 'overall'];
    statusElements.forEach(element => {
        document.getElementById(`${element}-status`).className = 'status-indicator status-running';
        document.getElementById(`${element}-text`).textContent = 'Checking...';
        document.getElementById(`${element}-detail`).textContent = 'Validating component...';
        document.getElementById(`${element}-card`).className = 'status-card';
    });
    
    // Reset progress bar
    document.getElementById('readiness-progress').style.width = '0%';
    document.getElementById('readiness-percentage').textContent = '0%';
    
    let readinessChecks = {
        database: { status: false, message: '', detail: '' },
        square: { status: false, message: '', detail: '' },
        tables: { status: false, message: '', detail: '' },
        overall: { status: false, message: '', detail: '' }
    };
    
    try {
        // Check admin status endpoint for comprehensive system info
        const response = await fetch('/admin/status');
        const result = await response.json();
        
        let readyCount = 0;
        
        // 1. Database Check
        if (result.database === 'connected') {
            readinessChecks.database = {
                status: true,
                message: 'Database Connected',
                detail: 'Successfully connected to production database'
            };
            document.getElementById('db-status').className = 'status-indicator status-ready';
            document.getElementById('db-card').className = 'status-card ready';
            readyCount++;
        } else {
            readinessChecks.database = {
                status: false,
                message: 'Database Issue',
                detail: `Connection status: ${result.database}`
            };
            document.getElementById('db-status').className = 'status-indicator status-error';
            document.getElementById('db-card').className = 'status-card error';
        }
        document.getElementById('db-text').textContent = readinessChecks.database.message;
        document.getElementById('db-detail').textContent = readinessChecks.database.detail;
        
        // 2. Square API Check
        if (result.square_config === 'configured') {
            readinessChecks.square = {
                status: true,
                message: 'Square API Ready',
                detail: 'Access token configured and available'
            };
            document.getElementById('square-status').className = 'status-indicator status-ready';
            document.getElementById('square-card').className = 'status-card ready';
            readyCount++;
        } else {
            readinessChecks.square = {
                status: false,
                message: 'Square API Missing',
                detail: 'SQUARE_ACCESS_TOKEN not configured'
            };
            document.getElementById('square-status').className = 'status-indicator status-error';
            document.getElementById('square-card').className = 'status-card error';
        }
        document.getElementById('square-text').textContent = readinessChecks.square.message;
        document.getElementById('square-detail').textContent = readinessChecks.square.detail;
        
        // 3. Tables Check
        if (result.tables_exist && result.location_count !== undefined) {
            readinessChecks.tables = {
                status: true,
                message: 'Tables Ready',
                detail: `${result.location_count} locations found, tables exist`
            };
            document.getElementById('tables-status').className = 'status-indicator status-ready';
            document.getElementById('tables-card').className = 'status-card ready';
            readyCount++;
        } else {
            readinessChecks.tables = {
                status: false,
                message: 'Tables Missing',
                detail: 'Required database tables not found'
            };
            document.getElementById('tables-status').className = 'status-indicator status-error';
            document.getElementById('tables-card').className = 'status-card error';
        }
        document.getElementById('tables-text').textContent = readinessChecks.tables.message;
        document.getElementById('tables-detail').textContent = readinessChecks.tables.detail;
        
        // 4. Overall Readiness Assessment
        const allReady = readinessChecks.database.status && 
                        readinessChecks.square.status && 
                        readinessChecks.tables.status;
        
        if (allReady) {
            readinessChecks.overall = {
                status: true,
                message: 'Ready to Sync',
                detail: 'All components validated successfully'
            };
            document.getElementById('overall-status').className = 'status-indicator status-ready';
            document.getElementById('overall-card').className = 'status-card ready';
            readyCount++;
        } else {
            const failedComponents = [];
            if (!readinessChecks.database.status) failedComponents.push('Database');
            if (!readinessChecks.square.status) failedComponents.push('Square API');
            if (!readinessChecks.tables.status) failedComponents.push('Tables');
            
            readinessChecks.overall = {
                status: false,
                message: 'Not Ready',
                detail: `Issues: ${failedComponents.join(', ')}`
            };
            document.getElementById('overall-status').className = 'status-indicator status-error';
            document.getElementById('overall-card').className = 'status-card error';
        }
        document.getElementById('overall-text').textContent = readinessChecks.overall.message;
        document.getElementById('overall-detail').textContent = readinessChecks.overall.detail;
        
        // Update progress bar
        const progressPercentage = Math.round((readyCount / 4) * 100);
        document.getElementById('readiness-progress').style.width = `${progressPercentage}%`;
        document.getElementById('readiness-percentage').textContent = `${progressPercentage}%`;
        
        // Show readiness summary
        showReadinessSummary(readinessChecks, allReady);
        
    } catch (error) {
        // Handle error case
        statusElements.forEach(element => {
            document.getElementById(`${element}-status`).className = 'status-indicator status-error';
            document.getElementById(`${element}-text`).textContent = 'Check Failed';
            document.getElementById(`${element}-detail`).textContent = 'Unable to validate component';
            document.getElementById(`${element}-card`).className = 'status-card error';
        });
        
        showReadinessSummary(null, false, error.message);
    }
}

function showReadinessSummary(checks, isReady, errorMessage = null) {
    const summaryEl = document.getElementById('readiness-summary');
    summaryEl.classList.remove('hidden');
    
    if (errorMessage) {
        summaryEl.className = 'mt-4 p-3 rounded border border-red-200 bg-red-50';
        summaryEl.innerHTML = `
            <div class="flex items-center">
                <span class="text-red-600 font-semibold">‚ùå Readiness Check Failed</span>
            </div>
            <p class="text-sm text-red-700 mt-1">
                Unable to validate system readiness: ${errorMessage}
            </p>
        `;
        return;
    }
    
    if (isReady) {
        summaryEl.className = 'mt-4 p-3 rounded border border-green-200 bg-green-50';
        summaryEl.innerHTML = `
            <div class="flex items-center justify-between">
                <span class="text-green-800 font-semibold">‚úÖ System Ready for Production Sync</span>
                <button onclick="checkSyncReadiness()" class="text-xs text-green-600 hover:text-green-800">üîÑ Recheck</button>
            </div>
            <p class="text-sm text-green-700 mt-1">
                All components validated successfully. You can safely run incremental or full refresh syncs.
            </p>
        `;
    } else {
        summaryEl.className = 'mt-4 p-3 rounded border border-yellow-200 bg-yellow-50';
        
        let issuesList = '';
        if (checks) {
            if (!checks.database.status) issuesList += `<li>üî¥ Database: ${checks.database.detail}</li>`;
            if (!checks.square.status) issuesList += `<li>üî¥ Square API: ${checks.square.detail}</li>`;
            if (!checks.tables.status) issuesList += `<li>üî¥ Tables: ${checks.tables.detail}</li>`;
        }
        
        summaryEl.innerHTML = `
            <div class="flex items-center justify-between">
                <span class="text-yellow-800 font-semibold">‚ö†Ô∏è System Not Ready for Sync</span>
                <button onclick="checkSyncReadiness()" class="text-xs text-yellow-600 hover:text-yellow-800">üîÑ Recheck</button>
            </div>
            <p class="text-sm text-yellow-700 mt-1">
                Please resolve the following issues before running a sync:
            </p>
            <ul class="text-sm text-yellow-700 mt-2 ml-4">
                ${issuesList}
            </ul>
        `;
    }
}

async function runCompleteSync() {
    if (syncInProgress) return;
    
    syncInProgress = true;
    const btn = document.getElementById('complete-sync-btn');
    const btnText = document.getElementById('complete-btn-text');
    const status = document.getElementById('complete-status');
    const log = document.getElementById('complete-log');
    const fullRefreshCheckbox = document.getElementById('full-refresh-checkbox');
    
    // Get sync mode
    const fullRefresh = fullRefreshCheckbox.checked;
    const syncMode = fullRefresh ? 'FULL REFRESH' : 'INCREMENTAL';
    
    // Reset and show timeline
    resetSyncTimeline();
    
    // Update UI
    btn.disabled = true;
    btnText.textContent = fullRefresh ? 'üî• Running Full Refresh...' : 'üöÄ Running Incremental Sync...';
    status.innerHTML = `<span class="status-indicator status-running"></span><span>${syncMode} sync in progress...</span>`;
    log.className = 'log-output';
    log.textContent = `Starting ${syncMode} production sync...\n`;
    
    if (fullRefresh) {
        log.textContent += '‚ö†Ô∏è  FULL REFRESH MODE - This will wipe and rebuild all data\n';
    } else {
        log.textContent += 'üìà INCREMENTAL MODE - Only updating changed data\n';
    }
    
    log.textContent += 'This will sync all data in the proper order:\n\n';
    
    // Simulate sync progress with timeline animation
    animateSyncProgress(1);
    log.textContent += 'üìç Step 1: Syncing locations...\n';
    
    try {
        const response = await fetch('/admin/complete-sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                full_refresh: fullRefresh
            })
        });
        const result = await response.json();
        
        if (result.success) {
            // Animate through all steps quickly to show completion
            for (let step = 1; step <= 4; step++) {
                animateSyncProgress(step);
                await new Promise(resolve => setTimeout(resolve, 200)); // Small delay for visual effect
            }
            
            // Mark all steps as completed
            for (let step = 1; step <= 4; step++) {
                updateSyncStep(step, 'completed');
            }
            
            log.textContent += `\nüéâ ${syncMode} sync finished successfully!\n`;
            log.textContent += `üìã ${result.message}\n\n`;
            
            // Display detailed statistics
            if (result.sync_stats) {
                log.textContent += 'üìä Sync Statistics:\n';
                const stats = result.sync_stats;
                
                log.textContent += `üìç Locations: ${stats.locations.created} created, ${stats.locations.updated} updated, ${stats.locations.deleted} deleted\n`;
                log.textContent += `üìÇ Categories: ${stats.categories.created} created, ${stats.categories.updated} updated, ${stats.categories.deleted} deleted\n`;
                log.textContent += `üè∑Ô∏è  Items: ${stats.items.created} created, ${stats.items.updated} updated, ${stats.items.deleted} deleted\n`;
                log.textContent += `üîß Variations: ${stats.variations.created} created, ${stats.variations.updated} updated, ${stats.variations.deleted} deleted\n`;
                log.textContent += `üì¶ Inventory: ${stats.inventory.created} created, ${stats.inventory.updated} updated, ${stats.inventory.deleted} deleted\n`;
                
                // Display vendor sync results
                if (stats.vendors) {
                    if (stats.vendors.error) {
                        log.textContent += `üè™ Vendors: ‚ö†Ô∏è  ${stats.vendors.error}\n`;
                    } else {
                        log.textContent += `üè™ Vendors: ${stats.vendors.created} created, ${stats.vendors.updated} updated, ${stats.vendors.deleted} deleted\n`;
                    }
                }
                
                log.textContent += `\nüî¢ Total Changes: ${result.total_changes}\n\n`;
            }
            
            // Display enhanced inventory features if available
            if (result.enhanced_features) {
                log.textContent += 'üöÄ Enhanced Features:\n';
                const enhanced = result.enhanced_features;
                
                if (enhanced.units_per_case_updates) {
                    const units = enhanced.units_per_case_updates;
                    log.textContent += `üìã Units Per Case Updates:\n`;
                    log.textContent += `   ‚Ä¢ ${units.items_updated} items updated (${units.items_with_units} with units)\n`;
                    log.textContent += `   ‚Ä¢ ${units.variations_updated} variations updated (${units.variations_with_units} with units)\n`;
                }
                
                if (enhanced.inventory_deduplication) {
                    const dedup = enhanced.inventory_deduplication;
                    log.textContent += `üìä Inventory Deduplication:\n`;
                    log.textContent += `   ‚Ä¢ ${dedup.raw_items} raw items processed\n`;
                    log.textContent += `   ‚Ä¢ ${dedup.unique_records} unique records after deduplication\n`;
                }
                
                log.textContent += '\n';
            }
            
            log.textContent += '‚úÖ Production database now has current data\n';
            log.textContent += '‚úÖ Reports should display accurate information\n';
            log.textContent += '‚úÖ All data relationships are correct\n';
            
            status.innerHTML = `<span class="status-indicator status-ready"></span><span>${syncMode} sync successful</span>`;
            
            // Refresh data status
            setTimeout(refreshDataStatus, 3000);
        } else {
            // Mark current step as error
            updateSyncStep(1, 'error');
            
            log.textContent += `‚ùå ${syncMode} sync failed: ${result.error}\n`;
            log.textContent += '\nPlease check the error above and try again.\n';
            log.textContent += 'You can also try running individual syncs if needed.\n';
            status.innerHTML = `<span class="status-indicator status-error"></span><span>${syncMode} sync failed</span>`;
        }
    } catch (error) {
        // Mark current step as error
        updateSyncStep(1, 'error');
        
        log.textContent += `‚ùå Error: ${error.message}\n`;
        log.textContent += '\nNetwork or server error occurred.\n';
        status.innerHTML = '<span class="status-indicator status-error"></span><span>Sync error</span>';
    } finally {
        syncInProgress = false;
        btn.disabled = false;
        
        // Reset button text based on checkbox state
        if (fullRefreshCheckbox.checked) {
            btnText.textContent = 'üî• Start Full Refresh Sync';
        } else {
            btnText.textContent = 'üöÄ Start Incremental Sync';
        }
    }
}

async function refreshDataStatus() {
    const statusEl = document.getElementById('data-status');
    statusEl.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><span class="ml-3 text-gray-600">Loading current database status...</span></div>';
    
    try {
        // Get data from updated catalog status endpoint
        const response = await fetch('/catalog/status');
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            statusEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="metric-card bg-blue-50" style="--accent-color: #3B82F6; --accent-color-dark: #2563EB;">
                        <div class="metric-label text-blue-700">Catalog Items</div>
                        <div class="metric-number text-blue-600">${(data.total_items || 0).toLocaleString()}</div>
                        <div class="metric-subtitle text-blue-600">Active products</div>
                    </div>
                    <div class="metric-card bg-green-50" style="--accent-color: #10B981; --accent-color-dark: #059669;">
                        <div class="metric-label text-green-700">Variations</div>
                        <div class="metric-number text-green-600">${(data.total_variations || 0).toLocaleString()}</div>
                        <div class="metric-subtitle text-green-600">Product options</div>
                    </div>
                    <div class="metric-card bg-purple-50" style="--accent-color: #8B5CF6; --accent-color-dark: #7C3AED;">
                        <div class="metric-label text-purple-700">Inventory Records</div>
                        <div class="metric-number text-purple-600">${(data.total_inventory || 0).toLocaleString()}</div>
                        <div class="metric-subtitle text-purple-600">Stock quantities</div>
                    </div>
                    <div class="metric-card bg-orange-50" style="--accent-color: #F59E0B; --accent-color-dark: #D97706;">
                        <div class="metric-label text-orange-700">Last Sync</div>
                        <div class="metric-number text-orange-600 text-lg">${data.last_sync_central ? data.last_sync_central.split(' ')[0] : 'Never'}</div>
                        <div class="metric-subtitle text-orange-600">${data.has_data ? 'Data Available' : 'No Data'}</div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full ${data.has_data ? 'bg-green-500' : 'bg-red-500'} mr-3"></div>
                            <span class="font-medium text-gray-800">
                                ${data.has_data ? 
                                    `‚úÖ Production database contains ${(data.total_items || 0).toLocaleString()} items with ${(data.total_variations || 0).toLocaleString()} variations and ${(data.total_inventory || 0).toLocaleString()} inventory records` : 
                                    '‚ùå No production data found - run Complete Production Sync to populate database'
                                }
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${data.has_data ? 'üü¢ Healthy' : 'üî¥ Needs Sync'}
                        </div>
                    </div>
                    ${data.last_sync_central ? `
                        <div class="mt-2 text-sm text-gray-600 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Last updated: ${data.last_sync_central}
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('status-last-updated').textContent = `Last refreshed: ${new Date().toLocaleTimeString()}`;
        } else {
            statusEl.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-yellow-600 text-4xl mb-4">‚ö†Ô∏è</div>
                    <p class="text-yellow-600 font-medium">Unable to load data status</p>
                    <p class="text-sm text-gray-500 mt-2">Please check your database connection and try again</p>
                </div>
            `;
        }
    } catch (error) {
        statusEl.innerHTML = `
            <div class="text-center py-8">
                <div class="text-red-600 text-4xl mb-4">‚ùå</div>
                <p class="text-red-600 font-medium">Error loading status</p>
                <p class="text-sm text-gray-500 mt-2">${error.message}</p>
            </div>
        `;
    }
}

function toggleLogViewer() {
    const logViewer = document.getElementById('log-viewer');
    const btn = document.getElementById('log-viewer-btn');
    
    if (logViewer.classList.contains('hidden')) {
        logViewer.classList.remove('hidden');
        btn.textContent = 'üìñ Hide Logs';
        refreshLogs(); // Load logs when showing
    } else {
        logViewer.classList.add('hidden');
        btn.textContent = 'üìñ Show Recent Logs';
    }
}

async function refreshLogs() {
    const logContent = document.getElementById('log-content');
    const logTimestamp = document.getElementById('log-timestamp');
    
    logContent.textContent = 'Loading logs...';
    logTimestamp.textContent = 'Loading...';
    
    try {
        // Try to get recent logs from the server
        const response = await fetch('/admin/logs');
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.logs) {
                logContent.textContent = result.logs;
                logTimestamp.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            } else {
                logContent.textContent = result.message || 'No logs available';
                logTimestamp.textContent = new Date().toLocaleTimeString();
            }
        } else {
            // Fallback to showing instructions for manual log viewing
            logContent.textContent = `üìã To view production logs manually, run:

gcloud run services logs read nytex-dashboard --region us-central1 --limit=50

Or for real-time logs:
gcloud run services logs tail nytex-dashboard --region us-central1

üìù Recent sync activity should appear in the logs above when running syncs.`;
            logTimestamp.textContent = new Date().toLocaleTimeString();
        }
    } catch (error) {
        logContent.textContent = `‚ùå Error loading logs: ${error.message}

üìã Manual log viewing commands:
gcloud run services logs read nytex-dashboard --region us-central1 --limit=50

For real-time monitoring:
gcloud run services logs tail nytex-dashboard --region us-central1`;
        logTimestamp.textContent = new Date().toLocaleTimeString();
    }
}

function downloadLogs() {
    // Create a download link for the current logs
    try {
        const logContent = document.getElementById('log-content').textContent;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `nytex-admin-logs-${timestamp}.txt`;
        
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        // Show temporary feedback
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Downloaded!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    } catch (error) {
        alert('Error downloading logs: ' + error.message);
    }
}

// Toggle Config Details with proper button text updates
async function toggleConfigDetails() {
    const statusEl = document.getElementById('quick-status');
    const btn = document.getElementById('config-details-btn');
    
    // If currently visible, hide it
    if (!statusEl.classList.contains('hidden')) {
        statusEl.classList.add('hidden');
        btn.textContent = '‚öôÔ∏è Show Config Details';
        return;
    }
    
    // Show and load data
    statusEl.classList.remove('hidden');
    btn.textContent = '‚öôÔ∏è Hide Config Details';
    await loadConfigDetails();
}

// Function to load configuration details
async function loadConfigDetails() {
    const statusEl = document.getElementById('quick-status');
    statusEl.innerHTML = '<p class="text-gray-600">Loading configuration details...</p>';
    
    try {
        const response = await fetch('/admin/debug-db-config');
        const result = await response.json();
        
        if (response.ok && result) {
            let statusHtml = '<div class="bg-gradient-to-r from-cyan-50 to-blue-50 p-4 rounded-lg border border-cyan-200">';
            statusHtml += '<h4 class="font-bold text-gray-800 mb-3 flex items-center">‚öôÔ∏è Configuration Details</h4>';
            statusHtml += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            // Left column - Environment Variables
            statusHtml += '<div class="space-y-3">';
            statusHtml += '<div class="font-medium text-gray-700 mb-2">Environment Variables</div>';
            
            if (result.environment_variables) {
                // Define which variables are expected in different environments
                const productionVars = ['DATABASE_URL', 'CLOUD_SQL_CONNECTION_NAME'];
                const developmentVars = ['SQLALCHEMY_DATABASE_URI'];
                const optionalVars = ['DB_USER', 'DB_PASS', 'DB_NAME'];
                
                for (const [key, value] of Object.entries(result.environment_variables)) {
                    const isSet = value !== 'NOT_SET';
                    let statusColor, statusIcon, statusText;
                    
                    if (isSet) {
                        statusColor = 'text-green-600';
                        statusIcon = '‚úÖ';
                        statusText = 'Set';
                    } else if (productionVars.includes(key)) {
                        statusColor = 'text-yellow-600';
                        statusIcon = '‚ö†Ô∏è';
                        statusText = 'Production Only';
                    } else if (optionalVars.includes(key)) {
                        statusColor = 'text-gray-500';
                        statusIcon = '‚ÑπÔ∏è';
                        statusText = 'Optional';
                    } else {
                        statusColor = 'text-red-600';
                        statusIcon = '‚ùå';
                        statusText = 'Missing';
                    }
                    
                    statusHtml += `<div class="flex justify-between items-center text-sm">
                        <span class="font-mono">${key}:</span>
                        <span class="${statusColor}">${statusIcon} ${statusText}</span>
                    </div>`;
                }
            }
            
            statusHtml += '</div>'; // Close left column
            
            // Right column - URL Configuration
            statusHtml += '<div class="space-y-3">';
            statusHtml += '<div class="font-medium text-gray-700 mb-2">Database URLs</div>';
            
            if (result.constructed_urls) {
                for (const [key, url] of Object.entries(result.constructed_urls)) {
                    statusHtml += `<div class="text-sm">
                        <div class="font-mono text-xs text-gray-600">${key}:</div>
                        <div class="text-xs break-all bg-gray-100 p-1 rounded">${url}</div>
                    </div>`;
                }
            }
            
            // URL Matches
            if (result.url_matches) {
                statusHtml += '<div class="mt-3 pt-2 border-t border-gray-200">';
                statusHtml += '<div class="font-medium text-gray-700 mb-2 text-sm">Database Connection Status</div>';
                
                // Check if we have any actual database URL set
                const hasDbUrl = result.constructed_urls && 
                    Object.values(result.constructed_urls).some(url => url && url !== 'NOT_SET' && !url.includes('NOT_SET'));
                
                if (hasDbUrl) {
                    statusHtml += `<div class="flex justify-between items-center text-xs">
                        <span>Database Connection:</span>
                        <span class="text-green-600">‚úÖ Active</span>
                    </div>`;
                    
                    for (const [key, matches] of Object.entries(result.url_matches)) {
                        let statusColor, statusIcon, statusText;
                        if (key === 'runtime_vs_static' && !matches) {
                            // This is expected in development
                            statusColor = 'text-gray-500';
                            statusIcon = '‚ÑπÔ∏è';
                            statusText = 'Expected (Dev Mode)';
                        } else if (matches) {
                            statusColor = 'text-green-600';
                            statusIcon = '‚úÖ';
                            statusText = 'Consistent';
                        } else {
                            statusColor = 'text-yellow-600';
                            statusIcon = '‚ö†Ô∏è';
                            statusText = 'Check Config';
                        }
                        
                        statusHtml += `<div class="flex justify-between items-center text-xs">
                            <span>${key.replace(/_/g, ' ')}:</span>
                            <span class="${statusColor}">${statusIcon} ${statusText}</span>
                        </div>`;
                    }
                } else {
                    statusHtml += `<div class="flex justify-between items-center text-xs">
                        <span>Database Connection:</span>
                        <span class="text-red-600">‚ùå No URL Found</span>
                    </div>`;
                }
                statusHtml += '</div>';
            }
            
            statusHtml += '</div>'; // Close right column
            statusHtml += '</div>'; // Close grid
            
            // Add helpful explanation
            statusHtml += `<div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs">
                <div class="font-semibold text-blue-800 mb-1">Configuration Notes:</div>
                <div class="text-blue-700 space-y-1">
                    <div>‚Ä¢ <strong>Production Only</strong> variables are used in Google Cloud Run deployment</div>
                    <div>‚Ä¢ <strong>Optional</strong> variables are fallbacks and not required for local development</div>
                    <div>‚Ä¢ <strong>Expected (Dev Mode)</strong> indicates normal differences between environments</div>
                    <div>‚Ä¢ Your current setup is working correctly for development</div>
                </div>
            </div>`;
            
            // Add timestamp
            statusHtml += `<div class="mt-3 pt-2 border-t border-gray-200 text-xs text-gray-500">
                Last checked: ${new Date().toLocaleString()}
            </div>`;
            
            statusHtml += '</div>'; // Close container
            
            statusEl.innerHTML = statusHtml;
        } else {
            statusEl.innerHTML = '<p class="text-red-600">‚ùå Error loading configuration details</p>';
        }
    } catch (error) {
        statusEl.innerHTML = `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
    }
}

// Toggle Database Status with proper button text updates
async function toggleDatabaseStatus() {
    const statusEl = document.getElementById('quick-status');
    const btn = document.getElementById('database-status-btn');
    
    // If currently visible, hide it
    if (!statusEl.classList.contains('hidden')) {
        statusEl.classList.add('hidden');
        btn.textContent = 'üìã Show Database Status';
        return;
    }
    
    // Show and load data
    statusEl.classList.remove('hidden');
    btn.textContent = 'üìã Hide Database Status';
    await loadDatabaseStatus();
}

// Function to load database status data
async function loadDatabaseStatus() {
    const statusEl = document.getElementById('quick-status');
    statusEl.innerHTML = '<p class="text-gray-600">Loading comprehensive database statistics...</p>';
    
    try {
        const response = await fetch('/admin/database-stats');
        const result = await response.json();
        
        if (response.ok && result) {
            let statusHtml = '<div class="space-y-6">';
            
            // === SUMMARY SECTION ===
            statusHtml += `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                        üìä Database Summary
                        <span class="ml-2 text-xs text-gray-500">${new Date(result.timestamp).toLocaleString()}</span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${result.summary.total_records?.toLocaleString() || 'N/A'}</div>
                            <div class="text-sm text-gray-600">Total Records</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${result.summary.key_metrics?.orders?.toLocaleString() || 'N/A'}</div>
                            <div class="text-sm text-gray-600">Orders</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${result.summary.key_metrics?.catalog_items?.toLocaleString() || 'N/A'}</div>
                            <div class="text-sm text-gray-600">Catalog Items</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600">${result.summary.key_metrics?.locations?.toLocaleString() || 'N/A'}</div>
                            <div class="text-sm text-gray-600">Locations</div>
                        </div>
                    </div>
                </div>
            `;
            
            // === ORDERS SECTION ===
            if (result.orders && !result.orders.error) {
                statusHtml += `
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-bold text-gray-800 mb-3">üì¶ Orders Analytics</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Total Orders:</span>
                                        <span class="font-semibold">${result.orders.total_orders?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Total Line Items:</span>
                                        <span class="font-semibold">${result.orders.total_line_items?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Avg Items/Order:</span>
                                        <span class="font-semibold">${result.orders.metrics?.avg_line_items_per_order || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Last 30 Days:</span>
                                        <span class="font-semibold">${result.orders.recent_activity?.last_30_days?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="text-sm">
                                    <div class="font-medium mb-1">Date Range:</div>
                                    <div class="text-xs text-gray-600">
                                        ${result.orders.date_range?.oldest ? new Date(result.orders.date_range.oldest).toLocaleDateString() : 'N/A'} - 
                                        ${result.orders.date_range?.latest ? new Date(result.orders.date_range.latest).toLocaleDateString() : 'N/A'}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${result.orders.date_range?.span_days ? `(${result.orders.date_range.span_days} days)` : ''}
                                    </div>
                                    ${result.orders.metrics?.avg_order_value_cents ? `
                                        <div class="mt-2">
                                            <div class="font-medium">Avg Order Value:</div>
                                            <div class="text-green-600 font-semibold">$${(result.orders.metrics.avg_order_value_cents / 100).toFixed(2)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // === CATALOG SECTION ===
            if (result.catalog && !result.catalog.error) {
                statusHtml += `
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-bold text-gray-800 mb-3">üè™ Catalog & Inventory</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="font-medium mb-2">Product Variations:</div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>Total:</span>
                                        <span class="font-semibold">${result.catalog.variations?.total?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>With SKU:</span>
                                        <span class="text-green-600 font-semibold">${result.catalog.variations?.with_sku?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Without SKU:</span>
                                        <span class="text-red-600 font-semibold">${result.catalog.variations?.without_sku?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="font-medium mb-2">Inventory Status:</div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between">
                                        <span>In Stock:</span>
                                        <span class="text-green-600 font-semibold">${result.catalog.inventory?.in_stock?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Out of Stock:</span>
                                        <span class="text-red-600 font-semibold">${result.catalog.inventory?.out_of_stock?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Total Quantity:</span>
                                        <span class="font-semibold">${result.catalog.inventory?.total_quantity?.toLocaleString() || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // === ALL TABLES SECTION ===
            statusHtml += `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h4 class="font-bold text-gray-800 mb-3">üìã All Database Tables</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 text-sm">
            `;
            
            // Sort tables by count (descending)
            const sortedTables = Object.entries(result.tables || {})
                .filter(([_, tableData]) => typeof tableData.count === 'number')
                .sort(([,a], [,b]) => b.count - a.count);
            
            for (const [tableName, tableData] of sortedTables) {
                const countColor = tableData.count > 0 ? 'text-blue-600' : 'text-gray-400';
                statusHtml += `
                    <div class="bg-white p-2 rounded border" title="${tableData.description}">
                        <div class="font-medium text-gray-700 truncate">${tableName}</div>
                        <div class="text-lg font-bold ${countColor}">${tableData.count.toLocaleString()}</div>
                    </div>
                `;
            }
            
            // Show error tables
            for (const [tableName, tableData] of Object.entries(result.tables || {})) {
                if (tableData.count === 'ERROR') {
                    statusHtml += `
                        <div class="bg-red-50 p-2 rounded border border-red-200" title="${tableData.error}">
                            <div class="font-medium text-red-700 truncate">${tableName}</div>
                            <div class="text-sm text-red-500">ERROR</div>
                        </div>
                    `;
                }
            }
            
            statusHtml += '</div></div>';
            
            // === HEALTH SECTION ===
            if (result.health && !result.health.error) {
                statusHtml += `
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-bold text-gray-800 mb-3">üíΩ Database Health</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-medium mb-1">Database Size: <span class="text-blue-600">${result.health.database_size || 'N/A'}</span></div>
                                <div class="font-medium mb-2">Last Activity:</div>
                                <div class="space-y-1 text-xs text-gray-600">
                `;
                
                for (const [table, lastUpdate] of Object.entries(result.health.last_activity || {})) {
                    const timeAgo = lastUpdate ? new Date(lastUpdate).toLocaleString() : 'Never';
                    statusHtml += `<div>${table}: ${timeAgo}</div>`;
                }
                
                statusHtml += `
                                </div>
                            </div>
                            <div>
                                <div class="font-medium mb-2">Largest Tables:</div>
                                <div class="space-y-1 text-xs">
                `;
                
                for (const [table, size] of Object.entries(result.health.largest_tables || {})) {
                    statusHtml += `<div class="flex justify-between"><span>${table.replace('public.', '')}:</span><span class="font-medium">${size}</span></div>`;
                }
                
                statusHtml += '</div></div></div></div>';
            }
            
            statusHtml += '</div>'; // Close main container
            
            statusEl.innerHTML = statusHtml;
        } else {
            statusEl.innerHTML = '<p class="text-red-600">‚ùå Error loading database statistics</p>';
        }
    } catch (error) {
        statusEl.innerHTML = `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
    }
}

// Toggle System Health with proper button text updates
async function toggleSystemHealth() {
    const statusEl = document.getElementById('quick-status');
    const btn = document.getElementById('system-health-btn');
    
    // If currently visible, hide it
    if (!statusEl.classList.contains('hidden')) {
        statusEl.classList.add('hidden');
        btn.textContent = 'üíö Show System Health';
        return;
    }
    
    // Show and load data
    statusEl.classList.remove('hidden');
    btn.textContent = 'üíö Hide System Health';
    await loadSystemHealth();
}

// Function to load system health data
async function loadSystemHealth() {
    const statusEl = document.getElementById('quick-status');
    statusEl.innerHTML = '<p class="text-gray-600">Checking system health...</p>';
    
    try {
        const response = await fetch('/admin/status');
        const result = await response.json();
        
        if (response.ok && result) {
            let statusHtml = '<div class="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">';
            statusHtml += '<h4 class="font-bold text-gray-800 mb-3 flex items-center">üíö System Health Check</h4>';
            statusHtml += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            // Left column - Core Systems
            statusHtml += '<div class="space-y-3">';
            statusHtml += '<div class="font-medium text-gray-700 mb-2">Core Systems</div>';
            
            // Database status
            const dbStatus = result.database === 'connected' ? '‚úÖ' : '‚ùå';
            const dbColor = result.database === 'connected' ? 'text-green-600' : 'text-red-600';
            statusHtml += `<div class="flex justify-between items-center">
                <span>Database:</span>
                <span class="${dbColor} font-semibold">${dbStatus} ${result.database}</span>
            </div>`;
            
            // Square config status
            const squareStatus = result.square_config === 'configured' ? '‚úÖ' : '‚ùå';
            const squareColor = result.square_config === 'configured' ? 'text-green-600' : 'text-red-600';
            statusHtml += `<div class="flex justify-between items-center">
                <span>Square API:</span>
                <span class="${squareColor} font-semibold">${squareStatus} ${result.square_config}</span>
            </div>`;
            
            // Table existence
            const tablesStatus = result.tables_exist ? '‚úÖ' : '‚ùå';
            const tablesColor = result.tables_exist ? 'text-green-600' : 'text-red-600';
            statusHtml += `<div class="flex justify-between items-center">
                <span>Tables:</span>
                <span class="${tablesColor} font-semibold">${tablesStatus} ${result.tables_exist ? 'Exist' : 'Missing'}</span>
            </div>`;
            
            statusHtml += '</div>'; // Close left column
            
            // Right column - Data Status
            statusHtml += '<div class="space-y-3">';
            statusHtml += '<div class="font-medium text-gray-700 mb-2">Data Status</div>';
            
            // Location count
            if (result.location_count !== undefined) {
                statusHtml += `<div class="flex justify-between items-center">
                    <span>Locations:</span>
                    <span class="text-blue-600 font-semibold">üìç ${result.location_count}</span>
                </div>`;
            }
            
            // Add timestamp
            statusHtml += `<div class="flex justify-between items-center">
                <span>Last Check:</span>
                <span class="text-gray-500 text-sm">${new Date().toLocaleTimeString()}</span>
            </div>`;
            
            // Overall status
            const allHealthy = result.database === 'connected' && 
                             result.square_config === 'configured' && 
                             result.tables_exist;
            const overallStatus = allHealthy ? 'üü¢ System Healthy' : 'üü° Issues Detected';
            const overallColor = allHealthy ? 'text-green-600' : 'text-yellow-600';
            statusHtml += `<div class="pt-2 border-t border-gray-200">
                <div class="flex justify-between items-center font-semibold">
                    <span>Overall Status:</span>
                    <span class="${overallColor}">${overallStatus}</span>
                </div>
            </div>`;
            
            statusHtml += '</div>'; // Close right column
            statusHtml += '</div>'; // Close grid
            statusHtml += '</div>'; // Close container
            
            statusEl.innerHTML = statusHtml;
        } else {
            statusEl.innerHTML = '<p class="text-red-600">‚ùå Error checking system health</p>';
        }
    } catch (error) {
        statusEl.innerHTML = `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
    }
}

// Timeline animation functions
function resetSyncTimeline() {
    const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
    steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        const icon = step.querySelector('.step-icon');
        step.className = 'timeline-item';
        icon.className = 'step-icon pending';
    });
}

function updateSyncStep(stepNumber, status) {
    const stepId = `step-${stepNumber}`;
    const step = document.getElementById(stepId);
    const icon = step.querySelector('.step-icon');
    
    // Remove all status classes
    step.classList.remove('active', 'completed', 'error');
    icon.classList.remove('pending', 'active', 'completed', 'error');
    
    // Add new status
    if (status === 'active') {
        step.classList.add('active');
        icon.classList.add('active');
    } else if (status === 'completed') {
        step.classList.add('completed');
        icon.classList.add('completed');
        icon.innerHTML = '‚úì';
    } else if (status === 'error') {
        step.classList.add('error');
        icon.classList.add('error');
        icon.innerHTML = '‚úó';
    } else {
        icon.classList.add('pending');
        icon.innerHTML = stepNumber;
    }
}

function animateSyncProgress(currentStep) {
    // Mark previous steps as completed
    for (let i = 1; i < currentStep; i++) {
        updateSyncStep(i, 'completed');
    }
    
    // Mark current step as active
    if (currentStep <= 4) {
        updateSyncStep(currentStep, 'active');
    }
    
    // Keep remaining steps as pending
    for (let i = currentStep + 1; i <= 4; i++) {
        updateSyncStep(i, 'pending');
    }
}

// Progress polling variables
let progressPollingInterval = null;
let syncStartTime = null;

// Start progress polling
function startProgressPolling() {
    // Poll every 3 seconds
    progressPollingInterval = setInterval(updateProgressFromServer, 3000);
    updateProgressFromServer(); // Initial update
}

// Stop progress polling
function stopProgressPolling() {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
    }
}

// Update progress from server
async function updateProgressFromServer() {
    try {
        const response = await fetch('/admin/historical-orders-sync-status');
        const status = await response.json();
        
        const progressBar = document.getElementById('historical-progress-bar');
        const percentage = document.getElementById('historical-percentage');
        const details = document.getElementById('historical-details');
        const logDiv = document.getElementById('historical-log');
        const statusEl = document.getElementById('historical-status');
        
        if (status.is_running) {
            // Update progress bar
            progressBar.style.width = `${status.progress_percentage}%`;
            percentage.textContent = `${status.progress_percentage}%`;
            
            // Update details
            let detailsText = status.current_chunk_info;
            if (status.estimated_remaining_seconds) {
                const minutes = Math.round(status.estimated_remaining_seconds / 60);
                detailsText += ` (Est. ${minutes} min remaining)`;
            }
            details.textContent = detailsText;
            
            // Update status
            statusEl.innerHTML = '<span class="status-indicator status-running"></span>Running historical sync...';
            
            // Update log with current progress
            const progressLog = `Progress: ${status.completed_chunks}/${status.total_chunks} chunks, ${status.total_orders_synced} orders synced
Current: ${status.current_chunk_info}
Last update: ${new Date(status.last_update).toLocaleTimeString()}`;
            
            // Find existing progress log and replace it, or append
            const logContent = logDiv.textContent;
            const progressStartIndex = logContent.indexOf('Progress: ');
            if (progressStartIndex !== -1) {
                const beforeProgress = logContent.substring(0, progressStartIndex);
                logDiv.textContent = beforeProgress + progressLog;
            } else {
                logDiv.textContent += '\n\n' + progressLog;
            }
            
        } else if (status.completed_chunks > 0) {
            // Sync completed
            stopProgressPolling();
            
            progressBar.style.width = '100%';
            percentage.textContent = '100%';
            details.textContent = status.current_chunk_info;
            
            if (status.current_chunk_info.includes('‚úÖ')) {
                // Success
                statusEl.innerHTML = '<span class="status-indicator status-ready"></span>Historical sync completed successfully!';
                document.getElementById('historical-btn-text').textContent = '‚úÖ Historical Sync Completed';
                
                logDiv.textContent += `\n\nüéâ SYNC COMPLETED!
Total orders synced: ${status.total_orders_synced}
Chunks processed: ${status.completed_chunks}/${status.total_chunks}
Your annual sales comparison should now work in production!`;
            } else {
                // Failed
                statusEl.innerHTML = '<span class="status-indicator status-error"></span>Historical sync failed';
                document.getElementById('historical-btn-text').textContent = '‚ùå Historical Sync Failed';
                
                logDiv.textContent += `\n\n‚ùå SYNC FAILED: ${status.current_chunk_info}`;
            }
            
            if (status.errors && status.errors.length > 0) {
                logDiv.textContent += `\n\nErrors encountered:\n${status.errors.join('\n')}`;
            }
            
            // Re-enable button
            document.getElementById('historical-sync-btn').disabled = false;
            syncInProgress = false;
        }
        
    } catch (error) {
        console.error('Error polling progress:', error);
        // Continue polling unless it's a critical error
    }
}

// Historical Orders Sync Function
async function runHistoricalOrdersSync() {
    if (syncInProgress) {
        alert('Another sync is already in progress. Please wait for it to complete.');
        return;
    }

    // Confirm with user due to long-running nature
    const confirmed = confirm(`‚ö†Ô∏è IMPORTANT: Historical Orders Sync

This will sync ALL orders from January 2018 to present. This process:
‚Ä¢ May take 2-4 hours to complete
‚Ä¢ Will fetch thousands of orders from Square API
‚Ä¢ Cannot be easily stopped once started
‚Ä¢ Is required for annual sales comparison to work

Are you sure you want to proceed?`);
    
    if (!confirmed) {
        return;
    }

    syncInProgress = true;
    syncStartTime = Date.now();
    
    const btn = document.getElementById('historical-sync-btn');
    const btnText = document.getElementById('historical-btn-text');
    const status = document.getElementById('historical-status');
    const logDiv = document.getElementById('historical-log');
    const progressDiv = document.getElementById('historical-sync-progress');
    const progressBar = document.getElementById('historical-progress-bar');
    const percentage = document.getElementById('historical-percentage');
    const details = document.getElementById('historical-details');
    
    // Update UI
    btn.disabled = true;
    btnText.textContent = 'üìÖ Syncing Historical Orders...';
    status.innerHTML = '<span class="status-indicator status-running"></span>Starting historical sync...';
    logDiv.classList.remove('hidden');
    progressDiv.classList.remove('hidden');
    logDiv.textContent = 'Starting historical orders sync...\nThis will take 2-4 hours. Progress will update automatically.\n';
    
    // Reset progress
    progressBar.style.width = '0%';
    percentage.textContent = '0%';
    details.textContent = 'Initializing sync...';
    
    // Start progress polling
    startProgressPolling();
    
    try {
        // Start the sync (this will run in background and update progress)
        const response = await fetch('/admin/historical-orders-sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // The response will come immediately but sync continues in background
        // Progress polling will handle the updates
        logDiv.textContent += 'Sync initiated successfully. Monitoring progress...\n';
        
    } catch (error) {
        stopProgressPolling();
        
        status.innerHTML = '<span class="status-indicator status-error"></span>Historical sync error';
        details.textContent = 'Failed to start sync';
        
        logDiv.textContent += `\n‚ùå ERROR: Failed to start sync: ${error.message}`;
        
        btnText.textContent = '‚ùå Failed to Start Sync';
        btn.disabled = false;
        syncInProgress = false;
    }
}

// Database Migration Function
async function runDatabaseMigration() {
    if (syncInProgress) {
        alert('Another operation is in progress. Please wait for it to complete.');
        return;
    }

    // Confirm with user
    const confirmed = confirm(`üîß Database Migration\n\nThis will add missing columns to the order_line_items table:\n‚Ä¢ variation_total_price_money\n‚Ä¢ item_variation_metadata\n\nThis is required for the historical orders sync to work properly.\n\nAre you sure you want to proceed?`);
    
    if (!confirmed) {
        return;
    }

    syncInProgress = true;
    
    const btn = document.getElementById('migration-btn');
    const btnText = document.getElementById('migration-btn-text');
    const status = document.getElementById('migration-status');
    const logDiv = document.getElementById('migration-log');
    
    // Update UI
    btn.disabled = true;
    btnText.textContent = 'üîß Running Migration...';
    status.innerHTML = '<span class="status-indicator status-running"></span>Running database migration...';
    logDiv.classList.remove('hidden');
    logDiv.textContent = 'Starting database migration...\n';
    
    try {
        const response = await fetch('/admin/migrate-order-line-items', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            btnText.textContent = '‚úÖ Migration Completed';
            status.innerHTML = '<span class="status-indicator status-ready"></span>Migration completed successfully!';
            
            logDiv.textContent += `‚úÖ ${result.message}\n`;
            if (result.added_columns && result.added_columns.length > 0) {
                logDiv.textContent += `Added columns: ${result.added_columns.join(', ')}\n`;
            }
            if (result.existing_columns && result.existing_columns.length > 0) {
                logDiv.textContent += `Existing columns: ${result.existing_columns.join(', ')}\n`;
            }
            logDiv.textContent += '\nüéâ Database migration completed! You can now run the historical orders sync.\n';
        } else {
            btnText.textContent = '‚ùå Migration Failed';
            status.innerHTML = '<span class="status-indicator status-error"></span>Migration failed';
            logDiv.textContent += `‚ùå Error: ${result.error}\n`;
        }
        
    } catch (error) {
        console.error('Migration error:', error);
        btnText.textContent = '‚ùå Migration Failed';
        status.innerHTML = '<span class="status-indicator status-error"></span>Migration failed';
        logDiv.textContent += `‚ùå Network error: ${error.message}\n`;
    }
    
    // Re-enable button after delay
    setTimeout(() => {
        btn.disabled = false;
        syncInProgress = false;
        if (!btnText.textContent.includes('‚úÖ') && !btnText.textContent.includes('‚ùå')) {
            btnText.textContent = 'üîß Run Database Migration';
            status.innerHTML = '<span class="status-indicator status-ready"></span>Ready to add missing columns';
        }
    }, 3000);
}
</script>
{% endblock %} 