<!-- Low Stock Report Table -->
<div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
                {% for column in columns %}
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    {% if column.sortable %}
                    <button 
                        type="button"
                        hx-get="{{ request.url._url.split('?')[0] }}?sort={{ column.key }}&direction={% if sort == column.key and direction == 'asc' %}desc{% elif sort == column.key and direction == 'desc' %}none{% else %}asc{% endif %}&view={{ view }}"
                        hx-target="#table-container"
                        hx-indicator="#loading-indicator"
                        class="flex items-center space-x-1 hover:text-gray-700 dark:hover:text-gray-200"
                    >
                        <span>{{ column.label }}</span>
                        {% if sort == column.key %}
                            {% if direction == "asc" %}
                                <i data-lucide="chevron-up" class="h-3 w-3"></i>
                            {% elif direction == "desc" %}
                                <i data-lucide="chevron-down" class="h-3 w-3"></i>
                            {% endif %}
                        {% else %}
                            <i data-lucide="chevrons-up-down" class="h-3 w-3 opacity-50"></i>
                        {% endif %}
                    </button>
                    {% else %}
                    {{ column.label }}
                    {% endif %}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            {% if items %}
                {% for item in items %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    {% for column in columns %}
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% set value = item[column.key] %}
                        
                        {% if column.key == "item_name" %}
                            <div class="font-medium text-gray-900 dark:text-white">{{ value or "N/A" }}</div>
                            {% if item.variation_name and item.variation_name != item.item_name %}
                                <div class="text-gray-500 dark:text-gray-400 text-xs">{{ item.variation_name }}</div>
                            {% endif %}
                        
                        {% elif column.key == "sku" %}
                            <span class="font-mono text-gray-700 dark:text-gray-300">{{ value or "N/A" }}</span>
                        
                        {% elif column.key == "vendor_name" %}
                            <span class="text-gray-900 dark:text-white">{{ value or "No Vendor" }}</span>
                        
                        {% elif column.key == "price" or column.key == "cost" %}
                            {% if value %}
                                <span class="text-gray-900 dark:text-white">${{ "%.2f"|format(value) }}</span>
                            {% else %}
                                <span class="text-gray-400 dark:text-gray-500">N/A</span>
                            {% endif %}
                        
                        {% elif column.key == "case_percentage" %}
                            {% if value is not none %}
                                <div class="flex items-center">
                                    <div class="flex-1">
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div class="bg-red-500 h-2 rounded-full" style="width: {{ [value, 100]|min }}%"></div>
                                        </div>
                                    </div>
                                    <span class="ml-2 text-xs font-medium text-gray-700 dark:text-gray-300">{{ value }}%</span>
                                </div>
                            {% else %}
                                <span class="text-gray-400 dark:text-gray-500">N/A</span>
                            {% endif %}
                        
                        {% elif column.get("type") == "location" %}
                            {% set location_name = column.key.replace("_qty", "") %}
                            {% set low_stock_key = location_name + "_low_stock" %}
                            {% set is_low_stock = item.get(low_stock_key, False) %}
                            
                            <div class="flex items-center">
                                {% if is_low_stock %}
                                    <div class="flex items-center text-red-600 dark:text-red-400">
                                        <i data-lucide="alert-triangle" class="h-4 w-4 mr-1"></i>
                                        <span class="font-medium">{{ value or 0 }}</span>
                                    </div>
                                {% else %}
                                    <span class="text-gray-900 dark:text-white">{{ value or 0 }}</span>
                                {% endif %}
                            </div>
                        
                        {% elif column.key == "locations_with_low_stock" %}
                            {% if value > 0 %}
                                <div class="flex items-center text-red-600 dark:text-red-400">
                                    <i data-lucide="map-pin" class="h-4 w-4 mr-1"></i>
                                    <span class="font-medium">{{ value }}</span>
                                </div>
                            {% else %}
                                <span class="text-gray-500 dark:text-gray-400">0</span>
                            {% endif %}
                        
                        {% elif column.key == "total_qty" %}
                            {% if item.is_low_stock_total %}
                                <div class="flex items-center text-red-600 dark:text-red-400">
                                    <i data-lucide="alert-triangle" class="h-4 w-4 mr-1"></i>
                                    <span class="font-medium">{{ value or 0 }}</span>
                                </div>
                            {% else %}
                                <span class="text-gray-900 dark:text-white">{{ value or 0 }}</span>
                            {% endif %}
                        
                        {% elif column.key == "low_stock_threshold" %}
                            <span class="text-orange-600 dark:text-orange-400 font-medium">{{ value or 0 }}</span>
                        
                        {% elif column.key == "units_per_case" %}
                            <span class="text-blue-600 dark:text-blue-400 font-medium">{{ value or "N/A" }}</span>
                        
                        {% else %}
                            <span class="text-gray-900 dark:text-white">{{ value or "N/A" }}</span>
                        
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="{{ columns|length }}" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center">
                            <i data-lucide="check-circle" class="h-12 w-12 text-green-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Great News!</h3>
                            <p class="text-gray-500 dark:text-gray-400">
                                {% if view == "location" %}
                                    No items have low stock at any individual location.
                                {% else %}
                                    No items have low stock in total inventory.
                                {% endif %}
                            </p>
                        </div>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Table Footer with Export Options -->
{% if items %}
<div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
        <div class="text-sm text-gray-500 dark:text-gray-400">
            Showing {{ items|length }} low stock item{{ 's' if items|length != 1 else '' }}
            {% if view == "location" %}
                with location-specific issues
            {% else %}
                with total inventory below threshold
            {% endif %}
        </div>
        
        <div class="flex items-center space-x-2">
            <button 
                type="button"
                onclick="window.open('/reports/export/{{ report_name }}?format=xlsx&view={{ view }}{% if sort %}&sort={{ sort }}&direction={{ direction }}{% endif %}', '_blank')"
                class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-500 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
                <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                Export Excel
            </button>
            
            <button 
                type="button"
                onclick="window.open('/reports/export/{{ report_name }}?format=pdf&view={{ view }}{% if sort %}&sort={{ sort }}&direction={{ direction }}{% endif %}', '_blank')"
                class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-500 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-600 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
                <i data-lucide="file-text" class="h-4 w-4 mr-2"></i>
                Export PDF
            </button>
        </div>
    </div>
</div>
{% endif %}

<script>
// Initialize Lucide icons after HTMX updates
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

// Re-initialize icons after HTMX requests
document.addEventListener('htmx:afterSwap', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script> 