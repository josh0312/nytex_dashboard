{% extends "base.html" %}

{% block title %}Items - NyTex Fireworks{% endblock %}

{% block head %}
<!-- Tabulator CSS -->
<link href="{{ url_for('static', path='css/tabulator_bootstrap5.min.css') }}" rel="stylesheet">
<style>
    :root {
        /* Light mode colors */
        --tabulator-bg: #ffffff;
        --tabulator-border: #e5e7eb;
        --tabulator-header-bg: #f9fafb;
        --tabulator-header-hover: #f3f4f6;
        --tabulator-header-text: #374151;
        --tabulator-row-bg: #ffffff;
        --tabulator-row-alt: #f9fafb;
        --tabulator-row-hover: #f3f4f6;
        --tabulator-row-border: #f3f4f6;
        --tabulator-text: #1f2937;
        --tabulator-text-muted: #6b7280;
        --tabulator-input-bg: #ffffff;
        --tabulator-input-border: #d1d5db;
        --tabulator-input-text: #374151;
        --tabulator-selection-bg: #dbeafe;
    }

    /* Dark mode colors */
    [data-theme="dark"], 
    .dark,
    @media (prefers-color-scheme: dark) {
        :root {
            --tabulator-bg: #1f2937;
            --tabulator-border: #374151;
            --tabulator-header-bg: #374151;
            --tabulator-header-hover: #4b5563;
            --tabulator-header-text: #f3f4f6;
            --tabulator-row-bg: #1f2937;
            --tabulator-row-alt: #111827;
            --tabulator-row-hover: #374151;
            --tabulator-row-border: #374151;
            --tabulator-text: #f3f4f6;
            --tabulator-text-muted: #9ca3af;
            --tabulator-input-bg: #374151;
            --tabulator-input-border: #4b5563;
            --tabulator-input-text: #f3f4f6;
            --tabulator-selection-bg: #1e40af;
        }
    }

    /* Apply dark mode when html has dark class or system prefers dark */
    html.dark {
        --tabulator-bg: #1f2937;
        --tabulator-border: #374151;
        --tabulator-header-bg: #374151;
        --tabulator-header-hover: #4b5563;
        --tabulator-header-text: #f3f4f6;
        --tabulator-row-bg: #1f2937;
        --tabulator-row-alt: #111827;
        --tabulator-row-hover: #374151;
        --tabulator-row-border: #374151;
        --tabulator-text: #f3f4f6;
        --tabulator-text-muted: #9ca3af;
        --tabulator-input-bg: #374151;
        --tabulator-input-border: #4b5563;
        --tabulator-input-text: #f3f4f6;
        --tabulator-selection-bg: #1e40af;
    }

    /* Tabulator base styling */
    .tabulator {
        background-color: var(--tabulator-bg) !important;
        border: 1px solid var(--tabulator-border) !important;
        border-radius: 0.5rem;
        overflow: hidden;
        color: var(--tabulator-text) !important;
    }
    
    /* Header styling */
    .tabulator .tabulator-header {
        background-color: var(--tabulator-header-bg) !important;
        border-bottom: 1px solid var(--tabulator-border) !important;
    }
    
    .tabulator .tabulator-col {
        background-color: var(--tabulator-header-bg) !important;
        border-right: 1px solid var(--tabulator-border) !important;
        color: var(--tabulator-header-text) !important;
    }
    
    .tabulator .tabulator-col:hover {
        background-color: var(--tabulator-header-hover) !important;
    }
    
    .tabulator .tabulator-col .tabulator-col-content {
        color: var(--tabulator-header-text) !important;
    }
    
    .tabulator .tabulator-col .tabulator-col-title {
        color: var(--tabulator-header-text) !important;
        font-weight: 600;
    }
    
    /* Sort arrows */
    .tabulator .tabulator-col .tabulator-col-sorter {
        color: var(--tabulator-text-muted) !important;
    }
    
    .tabulator .tabulator-col.tabulator-sortable .tabulator-col-sorter .tabulator-arrow {
        border-bottom-color: var(--tabulator-text-muted) !important;
        border-top-color: var(--tabulator-text-muted) !important;
    }
    
    /* Row styling */
    .tabulator .tabulator-tableholder .tabulator-table {
        background-color: var(--tabulator-bg) !important;
        color: var(--tabulator-text) !important;
    }
    
    .tabulator .tabulator-row {
        background-color: var(--tabulator-row-bg) !important;
        border-bottom: 1px solid var(--tabulator-row-border) !important;
        color: var(--tabulator-text) !important;
    }
    
    .tabulator .tabulator-row:hover {
        background-color: var(--tabulator-row-hover) !important;
    }
    
    .tabulator .tabulator-row.tabulator-row-even {
        background-color: var(--tabulator-row-bg) !important;
    }
    
    .tabulator .tabulator-row.tabulator-row-odd {
        background-color: var(--tabulator-row-alt) !important;
    }
    
    .tabulator .tabulator-row.tabulator-row-even:hover,
    .tabulator .tabulator-row.tabulator-row-odd:hover {
        background-color: var(--tabulator-row-hover) !important;
    }
    
    .tabulator .tabulator-row .tabulator-cell {
        color: var(--tabulator-text) !important;
        border-right: 1px solid var(--tabulator-row-border) !important;
    }
    
    /* Selected rows */
    .tabulator .tabulator-row.tabulator-selected {
        background-color: var(--tabulator-selection-bg) !important;
    }
    
    /* Filter input styling */
    .tabulator .tabulator-header-filter input,
    .tabulator .tabulator-header-filter select {
        background-color: var(--tabulator-input-bg) !important;
        border: 1px solid var(--tabulator-input-border) !important;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        color: var(--tabulator-input-text) !important;
    }
    
    .tabulator .tabulator-header-filter input::placeholder {
        color: var(--tabulator-text-muted) !important;
    }
    
    .tabulator .tabulator-header-filter input:focus,
    .tabulator .tabulator-header-filter select:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
        border-color: #3b82f6;
    }
    
    /* Multi-select filter dropdown styling */
    .tabulator .tabulator-header-filter .tabulator-list {
        background-color: var(--tabulator-input-bg) !important;
        border: 1px solid var(--tabulator-input-border) !important;
        border-radius: 0.375rem;
        color: var(--tabulator-input-text) !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
    }
    
    .tabulator .tabulator-header-filter .tabulator-list-item {
        background-color: var(--tabulator-input-bg) !important;
        color: var(--tabulator-input-text) !important;
        padding: 0.5rem;
        border-bottom: 1px solid var(--tabulator-row-border) !important;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    
    .tabulator .tabulator-header-filter .tabulator-list-item:hover {
        background-color: var(--tabulator-row-hover) !important;
    }
    
    .tabulator .tabulator-header-filter .tabulator-list-item.active {
        background-color: var(--tabulator-selection-bg) !important;
        color: white !important;
    }
    
    .tabulator .tabulator-header-filter .tabulator-list-item input[type="checkbox"] {
        margin-right: 0.5rem;
        accent-color: #3b82f6;
    }
    
    /* Filter button styling */
    .tabulator .tabulator-header-filter .tabulator-header-filter-list-select {
        background-color: var(--tabulator-input-bg) !important;
        border: 1px solid var(--tabulator-input-border) !important;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        color: var(--tabulator-input-text) !important;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 32px;
    }
    
    .tabulator .tabulator-header-filter .tabulator-header-filter-list-select:hover {
        background-color: var(--tabulator-row-hover) !important;
    }
    
    .tabulator .tabulator-header-filter .tabulator-header-filter-list-select:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
        border-color: #3b82f6;
    }
    
    /* Clear button in filters */
    .tabulator .tabulator-header-filter .tabulator-header-filter-list-select .tabulator-clear {
        background: none;
        border: none;
        color: var(--tabulator-text-muted) !important;
        cursor: pointer;
        padding: 0 0.25rem;
        font-size: 1rem;
        line-height: 1;
    }
    
    .tabulator .tabulator-header-filter .tabulator-header-filter-list-select .tabulator-clear:hover {
        color: var(--tabulator-text) !important;
    }
    
    /* Dropdown arrow */
    .tabulator .tabulator-header-filter .tabulator-header-filter-list-select:after {
        content: "▼";
        color: var(--tabulator-text-muted) !important;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }
    
    /* Filter badge for selected items */
    .tabulator .tabulator-header-filter .tabulator-header-filter-list-badge {
        background-color: #3b82f6 !important;
        color: white !important;
        border-radius: 9999px;
        padding: 0.125rem 0.5rem;
        font-size: 0.75rem;
        margin-left: 0.25rem;
        font-weight: 500;
    }
    
    /* Pagination styling */
    .tabulator .tabulator-footer {
        background-color: var(--tabulator-header-bg) !important;
        border-top: 1px solid var(--tabulator-border) !important;
        color: var(--tabulator-text) !important;
    }
    
    .tabulator .tabulator-paginator {
        color: var(--tabulator-text) !important;
    }
    
    .tabulator .tabulator-paginator .tabulator-page {
        background-color: var(--tabulator-input-bg) !important;
        border: 1px solid var(--tabulator-input-border) !important;
        color: var(--tabulator-text) !important;
    }
    
    .tabulator .tabulator-paginator .tabulator-page:hover {
        background-color: var(--tabulator-row-hover) !important;
    }
    
    .tabulator .tabulator-paginator .tabulator-page.active {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        color: white !important;
    }
    
    /* Loading and empty state */
    .tabulator .tabulator-loader {
        background-color: var(--tabulator-bg) !important;
        color: var(--tabulator-text) !important;
    }
    
    .tabulator .tabulator-placeholder {
        color: var(--tabulator-text-muted) !important;
    }
    
    /* Responsive collapse styling */
    .tabulator .tabulator-responsive-collapse {
        background-color: var(--tabulator-row-alt) !important;
        border-top: 1px solid var(--tabulator-border) !important;
    }
    
    .tabulator .tabulator-responsive-collapse-toggle {
        background-color: var(--tabulator-header-bg) !important;
        color: var(--tabulator-text) !important;
        border: 1px solid var(--tabulator-border) !important;
    }
    
    /* Export button styling */
    .export-buttons {
        margin-bottom: 1rem;
    }
    
    .export-buttons button {
        margin-right: 0.5rem;
        padding: 0.25rem 0.75rem;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background-color 0.2s;
    }
    
    .export-buttons button:hover {
        background-color: #2563eb;
    }
    
    .export-buttons button:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
    }
    
    /* Ensure icons work in both modes */
    .tabulator .tabulator-col .tabulator-col-sorter .tabulator-arrow {
        opacity: 0.6;
    }
    
    .tabulator .tabulator-col.tabulator-sortable:hover .tabulator-col-sorter .tabulator-arrow {
        opacity: 1;
    }
    
    /* Scrollbar styling for dark mode */
    .tabulator .tabulator-tableholder::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .tabulator .tabulator-tableholder::-webkit-scrollbar-track {
        background: var(--tabulator-row-alt);
    }
    
    .tabulator .tabulator-tableholder::-webkit-scrollbar-thumb {
        background: var(--tabulator-text-muted);
        border-radius: 4px;
    }
    
    .tabulator .tabulator-tableholder::-webkit-scrollbar-thumb:hover {
        background: var(--tabulator-text);
    }

    /* Mobile-specific styles */
    .mobile-item-row {
        transition: background-color 0.2s;
    }
    
    /* Mobile row hover effects - applied at table level */
    .dev-mobile-mode .tabulator .tabulator-row:hover {
        background-color: rgba(59, 130, 246, 0.1) !important;
        cursor: pointer !important;
    }
    
    /* Add visual indicator for mobile clickable rows */
    .dev-mobile-mode .tabulator .tabulator-row {
        position: relative;
    }
    
    .dev-mobile-mode .tabulator .tabulator-row::after {
        content: '';
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        border-right: 2px solid #9ca3af;
        border-bottom: 2px solid #9ca3af;
        transform: translateY(-50%) rotate(-45deg);
        opacity: 0.6;
    }

    /* Slide-in panel styles */
    .slide-panel {
        transition: transform 0.3s ease-in-out;
        background-color: white;
        color: #1f2937;
    }
    
    .dark .slide-panel {
        background-color: #1f2937;
        color: #f3f4f6;
    }
    
    .slide-panel.open {
        transform: translateX(0);
    }
    
    .slide-panel.closed {
        transform: translateX(100%);
    }
    
    /* Slide panel content styling */
    .slide-panel .panel-section {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
    }
    
    .dark .slide-panel .panel-section {
        background-color: #374151;
        border: 1px solid #4b5563;
    }
    
    .slide-panel .panel-text-primary {
        color: #1f2937;
    }
    
    .dark .slide-panel .panel-text-primary {
        color: #f3f4f6;
    }
    
    .slide-panel .panel-text-secondary {
        color: #6b7280;
    }
    
    .dark .slide-panel .panel-text-secondary {
        color: #9ca3af;
    }
    
    .slide-panel .panel-border {
        border-color: #e5e7eb;
    }
    
    .dark .slide-panel .panel-border {
        border-color: #4b5563;
    }

    /* Development toggle button */
    .dev-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 25px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .dev-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .dev-mobile-mode .desktop-filters { display: none !important; }
    .dev-mobile-mode .mobile-filters { display: block !important; }
    .dev-mobile-mode .desktop-view { display: none !important; }
    .dev-mobile-mode .mobile-view { display: block !important; }
    
    .mobile-filters { display: none; }
    .mobile-view { display: none; }
    
    /* Responsive filter visibility for actual mobile devices */
    @media (max-width: 767px) {
        .mobile-filters {
            display: block !important;
        }
        
        .desktop-filters {
            display: none !important;
        }
        
        /* Force hide desktop columns on mobile devices */
        .tabulator .tabulator-col[data-field="sku"],
        .tabulator .tabulator-col[data-field="description"],
        .tabulator .tabulator-col[data-field="vendor_name"],
        .tabulator .tabulator-col[data-field="vendor_code"],
        .tabulator .tabulator-col[data-field="cost"],
        .tabulator .tabulator-col[data-field="profit_margin_percent"],
        .tabulator .tabulator-col[data-field="profit_markup_percent"],
        .tabulator .tabulator-col[data-field="aubrey_qty"],
        .tabulator .tabulator-col[data-field="bridgefarmer_qty"],
        .tabulator .tabulator-col[data-field="building_qty"],
        .tabulator .tabulator-col[data-field="flomo_qty"],
        .tabulator .tabulator-col[data-field="justin_qty"],
        .tabulator .tabulator-col[data-field="quinlan_qty"],
        .tabulator .tabulator-col[data-field="terrell_qty"] {
            display: none !important;
        }
        
        /* Force hide desktop cell content on mobile devices */
        .tabulator .tabulator-cell[data-field="sku"],
        .tabulator .tabulator-cell[data-field="description"],
        .tabulator .tabulator-cell[data-field="vendor_name"],
        .tabulator .tabulator-cell[data-field="vendor_code"],
        .tabulator .tabulator-cell[data-field="cost"],
        .tabulator .tabulator-cell[data-field="profit_margin_percent"],
        .tabulator .tabulator-cell[data-field="profit_markup_percent"],
        .tabulator .tabulator-cell[data-field="aubrey_qty"],
        .tabulator .tabulator-cell[data-field="bridgefarmer_qty"],
        .tabulator .tabulator-cell[data-field="building_qty"],
        .tabulator .tabulator-cell[data-field="flomo_qty"],
        .tabulator .tabulator-cell[data-field="justin_qty"],
        .tabulator .tabulator-cell[data-field="quinlan_qty"],
        .tabulator .tabulator-cell[data-field="terrell_qty"] {
            display: none !important;
        }
        
        /* Ensure mobile row click behavior */
        .tabulator .tabulator-row:hover {
            background-color: rgba(59, 130, 246, 0.1) !important;
            cursor: pointer !important;
        }
        
        /* Add visual indicator for mobile clickable rows */
        .tabulator .tabulator-row {
            position: relative;
        }
        
        .tabulator .tabulator-row::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            border-right: 2px solid #9ca3af;
            border-bottom: 2px solid #9ca3af;
            transform: translateY(-50%) rotate(-45deg);
            opacity: 0.6;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Development Toggle Button (only show in development) -->
{% if debug %}
<button id="dev-toggle" class="dev-toggle" onclick="toggleMobileView()">
    📱 DEV: Switch to Mobile
</button>
{% endif %}

<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <!-- Combined Header and Controls -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-4 border border-gray-200 dark:border-gray-600">
        <!-- Title row with export buttons -->
        <div class="flex justify-between items-start mb-2">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Items Inventory</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    <span id="last-refresh">Loading...</span>
                </p>
            </div>
            <div class="export-buttons flex-shrink-0">
                <button id="download-xlsx" type="button">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4 inline mr-1"></i>
                    Excel
                </button>
            </div>
        </div>
        
        <!-- Desktop Global Search Row -->
        <div class="mb-3 desktop-filters">
            <div class="max-w-md">
                <label for="global-search" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Global Search
                </label>
                <input 
                    type="text" 
                    id="global-search" 
                    name="global-search"
                    placeholder="Search across all fields..."
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white text-sm"
                >
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Search across item names, SKUs, descriptions, categories, vendors, and codes
                </p>
            </div>
        </div>
        
        <!-- Mobile Simplified Filters -->
        <div class="mobile-filters space-y-3">
            <input 
                type="text" 
                id="mobile-global-search"
                placeholder="Search items..."
                class="w-full px-3 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
            >
            
            <select 
                id="mobile-category-filter"
                class="w-full px-3 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
            >
                <option value="">All Categories</option>
                {% for category in filter_options.categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Table info row -->
        <div class="flex justify-end">
            <div class="text-sm text-gray-600 dark:text-gray-400">
                <span id="table-info">Loading items...</span>
            </div>
        </div>
    </div>

    <!-- Tabulator Table Container -->
    <div id="items-table" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden border border-gray-200 dark:border-gray-600"></div>
</div>

<!-- Slide-in Panel for Item Details (Mobile) -->
<div id="item-slide-panel" 
     class="fixed inset-y-0 right-0 z-50 w-full sm:w-96 bg-white dark:bg-gray-800 shadow-xl slide-panel closed">
    
    <!-- Panel Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Item Details</h2>
        <button onclick="closeItemSlidePanel()" 
                class="p-2 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>
    
    <!-- Panel Content -->
    <div class="overflow-y-auto h-full pb-20">
        <div id="slide-panel-content" class="p-4">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- Backdrop -->
<div id="slide-panel-backdrop" 
     class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"
     onclick="closeItemSlidePanel()"></div>

<!-- Tabulator JavaScript -->
<script src="{{ url_for('static', path='js/vendor/tabulator.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Initialize Tabulator Table
let table;
let isMobileView = false; // Development flag

document.addEventListener('DOMContentLoaded', function() {
    // Get filter options for dropdowns
    const filterOptions = {{ filter_options | tojson }};
    
    // Function to update last refresh time
    function updateLastRefresh() {
        const now = new Date();
        const timeString = now.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
        document.getElementById('last-refresh').textContent = `Last refreshed: ${timeString}`;
    }
    
    // Function to check if we should show mobile view
    function shouldShowMobileView() {
        return isMobileView || window.innerWidth < 768;
    }
    
    // Make function available globally for formatter
    window.shouldShowMobileView = shouldShowMobileView;
    
    // Create Tabulator with responsive configuration
    console.log("Creating Tabulator table...");
    table = new Tabulator("#items-table", {
        // Data fetching
        ajaxURL: "/items/data",
        ajaxConfig: "GET",
        ajaxContentType: "json",
        
        // Pagination
        pagination: "remote",
        paginationMode: "remote", 
        paginationSize: 50,
        paginationSizeSelector: [25, 50, 100, 200],
        paginationCounter: "rows",
        
        // Filtering and sorting
        filterMode: "remote",
        sortMode: "remote",
        
        // Layout
        height: "600px",
        layout: "fitColumns",
        responsiveLayout: "collapse",
        placeholder: "No items found",
        tooltipsHeader: true,
        
        // Selection and interaction
        selectable: true,
        selectableRangeMode: "click",
        
        // Performance
        virtualDom: true,
        virtualDomBuffer: 300,
        
        // Columns configuration with mobile optimization
        columns: [
            // Always visible columns (mobile + desktop)
            {
                title: "Item Name", 
                field: "item_name", 
                width: 250, 
                frozen: true,
                sorter: "string",
                headerFilter: "input",
                headerFilterPlaceholder: "Search names...",
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue) return true;
                    return (rowValue || "").toLowerCase().includes(headerValue.toLowerCase());
                },
                formatter: function(cell, formatterParams) {
                    try {
                        const value = cell.getValue();
                        const row = cell.getRow().getData();
                        
                        if (shouldShowMobileView()) {
                            return `
                                <div class="mobile-item-row">
                                    <div class="font-medium text-gray-900 dark:text-white">${value}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${row.sku}</div>
                                </div>
                            `;
                        } else {
                            return `<div class="font-medium">${value}</div>`;
                        }
                    } catch (e) {
                        console.warn("Formatter error:", e);
                        return "";
                    }
                },
                tooltip: function(cell) {
                    try {
                        return cell.getValue();
                    } catch (e) {
                        console.warn("Tooltip error:", e);
                        return "";
                    }
                }
            },
            {
                title: "SKU", 
                field: "sku", 
                width: 120, 
                frozen: true,
                sorter: "string",
                headerFilter: "input",
                headerFilterPlaceholder: "Search SKUs...",
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue) return true;
                    return (rowValue || "").toLowerCase().includes(headerValue.toLowerCase());
                },
                responsive: 1 // Hidden on mobile since shown under item name
            },
            {
                title: "Category", 
                field: "category", 
                width: 150,
                sorter: "string",
                headerFilter: "list",
                headerFilterParams: {
                    values: filterOptions.categories,
                    multiselect: true,
                    clearable: true,
                    emptyValue: null
                },
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue || headerValue.length === 0) return true;
                    return headerValue.includes(rowValue);
                },
                responsive: 0
            },
            {
                title: "Price", 
                field: "price", 
                width: 100, 
                sorter: "number", 
                formatter: "money", 
                formatterParams: {symbol: "$", precision: 2},
                headerFilter: "list",
                headerFilterParams: {
                    values: filterOptions.prices,
                    multiselect: true,
                    clearable: true,
                    emptyValue: null
                },
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue || headerValue.length === 0) return true;
                    return headerValue.includes(rowValue);
                },
                responsive: 0
            },
            {
                title: "Stock", 
                field: "total_qty", 
                width: 80, 
                sorter: "number",
                hozAlign: "center",
                responsive: 0,
                formatter: function(cell, formatterParams) {
                    try {
                        const value = cell.getValue();
                        if (value === 0) return "0";
                        if (value > 0) return `<span style="color: #059669; font-weight: 600;">${value}</span>`;
                        return `<span style="color: #dc2626; font-weight: 600;">${value}</span>`;
                    } catch (e) {
                        console.warn("Formatter error:", e);
                        return "";
                    }
                }
            },
            
            // Desktop-only columns (hidden on mobile)
            {
                title: "Description", 
                field: "description", 
                width: 200,
                sorter: "string",
                headerFilter: "input",
                headerFilterPlaceholder: "Search descriptions...",
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue) return true;
                    return (rowValue || "").toLowerCase().includes(headerValue.toLowerCase());
                },
                tooltip: function(cell) {
                    try {
                        return cell.getValue();
                    } catch (e) {
                        console.warn("Tooltip error:", e);
                        return "";
                    }
                },
                responsive: 2
            },
            {
                title: "Vendor", 
                field: "vendor_name", 
                width: 150,
                sorter: "string",
                headerFilter: "list",
                headerFilterParams: {
                    values: filterOptions.vendors,
                    multiselect: true,
                    clearable: true,
                    emptyValue: null
                },
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue || headerValue.length === 0) return true;
                    return headerValue.includes(rowValue);
                },
                responsive: 3
            },
            {
                title: "Vendor Code", 
                field: "vendor_code", 
                width: 120,
                sorter: "string",
                headerFilter: "input",
                headerFilterPlaceholder: "Search codes...",
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue) return true;
                    return (rowValue || "").toLowerCase().includes(headerValue.toLowerCase());
                },
                responsive: 4
            },
            {
                title: "Cost", 
                field: "cost", 
                width: 100, 
                sorter: "number", 
                formatter: "money", 
                formatterParams: {symbol: "$", precision: 2},
                headerFilter: "list",
                headerFilterParams: {
                    values: filterOptions.costs,
                    multiselect: true,
                    clearable: true,
                    emptyValue: null
                },
                headerFilterFunc: function(headerValue, rowValue, rowData, filterParams) {
                    if (!headerValue || headerValue.length === 0) return true;
                    return headerValue.includes(rowValue);
                },
                responsive: 5
            },
            {
                title: "Margin", 
                field: "profit_margin_percent", 
                width: 100, 
                sorter: "number",
                formatter: function(cell, formatterParams) {
                    try {
                        const value = cell.getValue();
                        if (value === null || value === undefined) return "";
                        return value.toFixed(1) + "%";
                    } catch (e) {
                        console.warn("Formatter error:", e);
                        return "";
                    }
                },
                responsive: 6
            },
            {
                title: "Markup", 
                field: "profit_markup_percent", 
                width: 100, 
                sorter: "number",
                formatter: function(cell, formatterParams) {
                    try {
                        const value = cell.getValue();
                        if (value === null || value === undefined) return "";
                        return value.toFixed(1) + "%";
                    } catch (e) {
                        console.warn("Formatter error:", e);
                        return "";
                    }
                },
                responsive: 7
            },
            
            // Grouped Quantity Columns (desktop only)
            {
                title: "Quantity",
                responsive: 8,
                columns: [
                    {
                        title: "A", 
                        field: "aubrey_qty", 
                        width: 80, 
                        sorter: "number",
                        hozAlign: "center",
                        tooltip: "Aubrey Location",
                        responsive: 8
                    },
                    {
                        title: "BF", 
                        field: "bridgefarmer_qty", 
                        width: 80, 
                        sorter: "number",
                        hozAlign: "center",
                        tooltip: "Bridgefarmer Location",
                        responsive: 8
                    },
                    {
                        title: "B", 
                        field: "building_qty", 
                        width: 80, 
                        sorter: "number",
                        hozAlign: "center",
                        tooltip: "Building Location",
                        responsive: 8
                    },
                    {
                        title: "F", 
                        field: "flomo_qty", 
                        width: 80, 
                        sorter: "number",
                        hozAlign: "center",
                        tooltip: "FloMo Location",
                        responsive: 8
                    },
                    {
                        title: "J", 
                        field: "justin_qty", 
                        width: 80, 
                        sorter: "number",
                        hozAlign: "center",
                        tooltip: "Justin Location",
                        responsive: 8
                    },
                    {
                        title: "Q", 
                        field: "quinlan_qty", 
                        width: 80, 
                        sorter: "number",
                        hozAlign: "center",
                        tooltip: "Quinlan Location",
                        responsive: 8
                    },
                    {
                        title: "T", 
                        field: "terrell_qty", 
                        width: 80, 
                        sorter: "number",
                        hozAlign: "center",
                        tooltip: "Terrell Location",
                        responsive: 8
                    }
                ]
            }
        ],
        
        // Initial sort
        initialSort: [
            {column: "item_name", dir: "asc"}
        ],
        
        // Event handlers
        ajaxResponse: function(url, params, response) {
            // Update last refresh time
            updateLastRefresh();
            
            // Update table info
            const info = document.getElementById('table-info');
            if (info && response.last_row) {
                const shown = response.data ? response.data.length : 0;
                const total = response.last_row;
                const hasFilters = Object.keys(params).some(key => key.startsWith('filter'));
                
                if (hasFilters) {
                    info.textContent = `Showing ${shown} of ${total} items (filtered)`;
                } else {
                    info.textContent = `Showing ${shown} of ${total} items`;
                }
            }
            return response;
        },
        
        ajaxError: function(error) {
            console.error("AJAX Error:", error);
            document.getElementById('table-info').textContent = "Error loading data";
        },
        
        dataFiltered: function(filters, rows) {
            const info = document.getElementById('table-info');
            if (filters.length === 0) {
                info.textContent = `Showing all ${rows.length} items`;
            } else {
                info.textContent = `Showing ${rows.length} items (${filters.length} filter${filters.length > 1 ? 's' : ''} applied)`;
            }
        },
        
        // Handle filter clearing
        headerFilterClearButtonClicked: function(column) {
            setTimeout(() => {
                table.refreshFilter();
            }, 10);
        },
        
        // Table built callback - set initial mobile state if needed
        tableBuilt: function() {
            console.log("Table built successfully!");
            console.log("Table object:", table);
            console.log("Window width:", window.innerWidth);
            console.log("Should show mobile view:", shouldShowMobileView());
            
            // Always check mobile state and apply appropriate column visibility
            setTimeout(() => {
                updateColumnVisibilityForScreenSize();
            }, 100); // Small delay to ensure table is fully built
        },
        
        // Row click handler for mobile slide panel
        rowClick: function(e, row) {
            console.log("Row clicked!");
            console.log("Should show mobile view:", shouldShowMobileView());
            console.log("isMobileView:", isMobileView);
            console.log("window.innerWidth:", window.innerWidth);
            
            // Only handle row clicks in mobile view
            if (shouldShowMobileView()) {
                const rowData = row.getData();
                console.log("Row data:", rowData);
                if (rowData && rowData.sku) {
                    console.log("Opening slide panel for SKU:", rowData.sku);
                    openItemSlidePanel(rowData.sku);
                } else {
                    console.log("No SKU found in row data");
                }
            } else {
                console.log("Not in mobile view, ignoring click");
            }
        },
        
        // Row mouse events for visual feedback in mobile mode
        rowMouseEnter: function(e, row) {
            if (shouldShowMobileView()) {
                row.getElement().style.cursor = 'pointer';
                row.getElement().style.backgroundColor = 'rgba(59, 130, 246, 0.1)'; // Light blue highlight
            }
        },
        
        rowMouseLeave: function(e, row) {
            if (shouldShowMobileView()) {
                row.getElement().style.cursor = 'default';
                row.getElement().style.backgroundColor = ''; // Remove highlight
            }
        }
    });

    console.log("Table created, setting up additional event listeners...");
    
    // Test if we can attach click events to the table element directly
    document.addEventListener('click', function(e) {
        const tableElement = document.getElementById('items-table');
        if (tableElement && tableElement.contains(e.target)) {
            console.log("Click detected inside table area");
            console.log("Clicked element:", e.target);
            console.log("Mobile view?", shouldShowMobileView());
            
            // Check if this is a row click
            const rowElement = e.target.closest('.tabulator-row');
            if (rowElement && shouldShowMobileView()) {
                console.log("Row element found:", rowElement);
                
                // Try to get row data from Tabulator
                if (table) {
                    try {
                        const rows = table.getRows();
                        const clickedRow = rows.find(row => row.getElement() === rowElement);
                        if (clickedRow) {
                            const rowData = clickedRow.getData();
                            console.log("Found row data via DOM:", rowData);
                            if (rowData && rowData.sku) {
                                console.log("Opening slide panel for SKU (via DOM):", rowData.sku);
                                openItemSlidePanel(rowData.sku);
                            }
                        }
                    } catch (error) {
                        console.error("Error getting row data:", error);
                    }
                }
            }
        }
    });

    // Mobile search functionality
    let mobileSearchTimeout;
    const mobileGlobalSearchInput = document.getElementById("mobile-global-search");
    const mobileCategoryFilter = document.getElementById("mobile-category-filter");
    
    if (mobileGlobalSearchInput) {
        mobileGlobalSearchInput.addEventListener("input", function() {
            clearTimeout(mobileSearchTimeout);
            mobileSearchTimeout = setTimeout(function() {
                updateTableWithMobileFilters();
            }, 300);
        });
    }
    
    if (mobileCategoryFilter) {
        mobileCategoryFilter.addEventListener("change", function() {
            updateTableWithMobileFilters();
        });
    }
    
    function updateTableWithMobileFilters() {
        const searchTerm = mobileGlobalSearchInput ? mobileGlobalSearchInput.value.trim() : "";
        const category = mobileCategoryFilter ? mobileCategoryFilter.value : "";
        
        console.log("Mobile filters - Search:", searchTerm, "Category:", category);
        
        // Build new URL with parameters for remote filtering
        let newUrl = "/items/data";
        const params = [];
        
        if (searchTerm) {
            params.push("global_search=" + encodeURIComponent(searchTerm));
        }
        if (category) {
            params.push("category=" + encodeURIComponent(category));
        }
        
        if (params.length > 0) {
            newUrl += "?" + params.join("&");
        }
        
        console.log("Updating table with URL:", newUrl);
        
        // Update the table's AJAX URL and refresh data
        table.setData(newUrl);
    }

    // Export functionality
    document.getElementById("download-xlsx").addEventListener("click", function() {
        console.log("Export button clicked");
        
        // Get current filters and search criteria
        const globalSearch = document.getElementById("global-search")?.value || "";
        console.log("Global search:", globalSearch);
        
        // Get current filters applied to the table
        const currentFilters = table.getFilters();
        console.log("Current table filters:", currentFilters);
        
        // Get current sorting
        const currentSort = table.getSorters();
        console.log("Current table sorting:", currentSort);
        
        // Get the header filters from the filter module
        const headerFilters = table.modules.filter.headerFilters;
        console.log("Header filters object:", headerFilters);
        
        // Build query parameters object
        const params = {};
        
        // Add global search
        if (globalSearch.trim()) {
            params.global_search = globalSearch;
        }
        
        // Add sorting
        if (currentSort && currentSort.length > 0) {
            currentSort.forEach((sort, index) => {
                params[`sort[${index}][field]`] = sort.field;
                params[`sort[${index}][dir]`] = sort.dir;
            });
        }
        
        // Extract filters from header filters
        let filterIndex = 0;
        
        // Process header filters
        if (headerFilters) {
            Object.keys(headerFilters).forEach(field => {
                const filter = headerFilters[field];
                console.log(`Header filter for ${field}:`, filter);
                
                if (filter && filter.value !== undefined && filter.value !== null) {
                    // Handle different types of filter values
                    if (Array.isArray(filter.value) && filter.value.length > 0) {
                        // Multi-select filter (like category, vendor)
                        console.log(`Found ${field} filter values:`, filter.value);
                        params[`filter[${filterIndex}][field]`] = field;
                        params[`filter[${filterIndex}][type]`] = "function";
                        filter.value.forEach((val, valIndex) => {
                            params[`filter[${filterIndex}][value][${valIndex}]`] = val;
                        });
                        filterIndex++;
                    } else if (typeof filter.value === 'string' && filter.value.trim() !== '') {
                        // Text input filter (like item_name, sku, description)
                        console.log(`Found ${field} filter value:`, filter.value);
                        params[`filter[${filterIndex}][field]`] = field;
                        params[`filter[${filterIndex}][type]`] = "like";
                        params[`filter[${filterIndex}][value]`] = filter.value;
                        filterIndex++;
                    }
                }
            });
        }
        
        // Add filters from the original method as fallback
        if (currentFilters && currentFilters.length > 0) {
            currentFilters.forEach((filter, index) => {
                const actualIndex = filterIndex + index;
                params[`filter[${actualIndex}][field]`] = filter.field;
                params[`filter[${actualIndex}][type]`] = filter.type;
                
                // Handle different filter value types
                if (Array.isArray(filter.value)) {
                    filter.value.forEach((val, valIndex) => {
                        params[`filter[${actualIndex}][value][${valIndex}]`] = val;
                    });
                } else {
                    params[`filter[${actualIndex}][value]`] = filter.value;
                }
            });
        }
        
        // Build URL with parameters
        const queryString = new URLSearchParams(params).toString();
        const exportUrl = `/items/export?format=xlsx&${queryString}`;
        
        console.log("Export URL:", exportUrl);
        console.log("Export parameters:", params);
        
        // Fetch the export data and trigger download
        fetch(exportUrl)
            .then(response => {
                console.log("Export response received");
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error("Export error:", data.error);
                    alert("Export failed: " + data.error);
                    return;
                }
                
                console.log("Export data received:", data.total, "items");
                
                // Convert data to worksheet format
                const worksheet = XLSX.utils.json_to_sheet(data.data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Items Inventory");
                
                // Generate filename with timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `items_export_${timestamp}.xlsx`;
                
                // Download the file
                XLSX.writeFile(workbook, filename);
                console.log("Export completed:", filename);
            })
            .catch(error => {
                console.error("Export error:", error);
                alert("Export failed. Please try again.");
            });
    });

    // Global Search functionality
    let globalSearchTimeout;
    const globalSearchInput = document.getElementById("global-search");
    
    if (globalSearchInput) {
        globalSearchInput.addEventListener("input", function() {
            // Clear existing timeout
            clearTimeout(globalSearchTimeout);
            
            // Debounce the search to avoid too many requests
            globalSearchTimeout = setTimeout(function() {
                const searchTerm = globalSearchInput.value.trim();
                
                // Update the AJAX URL with the search parameter
                let newUrl = "/items/data";
                if (searchTerm) {
                    newUrl += "?global_search=" + encodeURIComponent(searchTerm);
                }
                
                // Update table's AJAX URL and refresh data
                table.setData(newUrl);
            }, 300); // 300ms delay
        });
        
        // Clear search on Escape key
        globalSearchInput.addEventListener("keydown", function(event) {
            if (event.key === "Escape") {
                globalSearchInput.value = "";
                table.setData("/items/data");
            }
        });
    }

    // Initialize Lucide icons
    lucide.createIcons();
    
    // Watch for theme changes and update table styling
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                // Theme changed, redraw table to apply new CSS variables
                if (table) {
                    table.redraw(true);
                }
            }
        });
    });
    
    // Observe changes to the html element's class attribute for dark mode
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
    });
});

// Development toggle functionality
function toggleMobileView() {
    const toggleBtn = document.getElementById('dev-toggle');
    if (!toggleBtn) {
        console.log("Development toggle not available (production mode)");
        return;
    }
    
    isMobileView = !isMobileView;
    console.log("Mobile view toggled. isMobileView now:", isMobileView);
    
    const bodyElement = document.body;
    
    if (isMobileView) {
        console.log("Switching to mobile mode");
        bodyElement.classList.add('dev-mobile-mode');
        toggleBtn.textContent = '🖥️ DEV: Switch to Desktop';
        
        // Hide desktop-only columns in mobile mode
        hideDesktopColumns();
    } else {
        console.log("Switching to desktop mode");
        bodyElement.classList.remove('dev-mobile-mode');
        toggleBtn.textContent = '📱 DEV: Switch to Mobile';
        
        // Show all columns in desktop mode
        showAllColumns();
    }
    
    // Redraw table to update mobile-specific formatting
    if (table) {
        table.redraw(true);
    }
}

// Function to hide desktop-only columns
function hideDesktopColumns() {
    if (!table) return;
    
    // Hide desktop-only columns
    const desktopColumns = [
        'sku',           // Hidden since shown under item name
        'description',   // Desktop only
        'vendor_name',   // Desktop only  
        'vendor_code',   // Desktop only
        'cost',          // Desktop only
        'profit_margin_percent',  // Desktop only
        'profit_markup_percent',  // Desktop only
        'aubrey_qty',    // Location quantities (desktop only)
        'bridgefarmer_qty',
        'building_qty',
        'flomo_qty',
        'justin_qty',
        'quinlan_qty',
        'terrell_qty'
    ];
    
    desktopColumns.forEach(columnField => {
        try {
            table.hideColumn(columnField);
        } catch (e) {
            // Column might not exist or already hidden
            console.log(`Could not hide column: ${columnField}`);
        }
    });
    
    console.log('Mobile mode: Hidden desktop columns');
}

// Function to show all columns
function showAllColumns() {
    if (!table) return;
    
    // Show all columns
    const allColumns = [
        'sku',
        'description',
        'vendor_name',
        'vendor_code', 
        'cost',
        'profit_margin_percent',
        'profit_markup_percent',
        'aubrey_qty',
        'bridgefarmer_qty',
        'building_qty',
        'flomo_qty',
        'justin_qty',
        'quinlan_qty',
        'terrell_qty'
    ];
    
    allColumns.forEach(columnField => {
        try {
            table.showColumn(columnField);
        } catch (e) {
            // Column might not exist
            console.log(`Could not show column: ${columnField}`);
        }
    });
    
    console.log('Desktop mode: Showed all columns');
}

// Function to update column visibility based on screen size
function updateColumnVisibilityForScreenSize() {
    if (!table) return;
    
    console.log("Updating column visibility - window width:", window.innerWidth, "Mobile view:", shouldShowMobileView());
    
    if (shouldShowMobileView()) {
        console.log("Applying mobile column layout");
        hideDesktopColumns();
        // Also show mobile filters and hide desktop filters
        showMobileFilters();
    } else {
        console.log("Applying desktop column layout");
        showAllColumns();
        // Show desktop filters and hide mobile filters
        showDesktopFilters();
    }
}

// Mobile slide panel functionality
function openItemSlidePanel(sku) {
    console.log("openItemSlidePanel called with SKU:", sku);
    console.log("shouldShowMobileView():", shouldShowMobileView());
    
    if (!shouldShowMobileView()) {
        console.log("Not in mobile view, returning early");
        return;
    }
    
    console.log("Setting loading state...");
    
    // Show loading state
    document.getElementById('slide-panel-content').innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-3 text-gray-600 dark:text-gray-400">Loading...</span>
        </div>
    `;
    
    console.log("Showing panel...");
    
    // Show panel
    document.getElementById('slide-panel-backdrop').classList.remove('hidden');
    document.getElementById('item-slide-panel').classList.remove('closed');
    document.getElementById('item-slide-panel').classList.add('open');
    document.body.style.overflow = 'hidden';
    
    // Fetch item details
    console.log("Fetching item details from:", `/items/details/${encodeURIComponent(sku)}`);
    
    fetch(`/items/details/${encodeURIComponent(sku)}`)
        .then(response => {
            console.log("Fetch response:", response);
            if (!response.ok) {
                throw new Error('Item not found');
            }
            return response.json();
        })
        .then(data => {
            console.log("Item details received:", data);
            document.getElementById('slide-panel-content').innerHTML = renderItemDetails(data);
            // Re-initialize Lucide icons for the new content
            lucide.createIcons();
        })
        .catch(error => {
            console.error('Error fetching item details:', error);
            document.getElementById('slide-panel-content').innerHTML = `
                <div class="text-center py-8">
                    <div class="text-red-600 dark:text-red-400 mb-2">
                        <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i>
                        Error Loading Item
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">
                        Could not load item details. Please try again.
                    </p>
                </div>
            `;
            lucide.createIcons();
        });
}

function closeItemSlidePanel() {
    document.getElementById('item-slide-panel').classList.remove('open');
    document.getElementById('item-slide-panel').classList.add('closed');
    document.getElementById('slide-panel-backdrop').classList.add('hidden');
    document.body.style.overflow = '';
}

function renderItemDetails(item) {
    return `
        <div class="space-y-6">
            <!-- Basic Info -->
            <div>
                <h3 class="text-lg font-medium panel-text-primary mb-1">
                    ${item.item_name || 'Unknown Item'}
                </h3>
                <p class="text-sm panel-text-secondary mb-1">
                    <strong>SKU:</strong> ${item.sku || 'N/A'}
                </p>
                <p class="text-sm panel-text-secondary">
                    <strong>Category:</strong> ${item.category || 'N/A'}
                </p>
                ${item.description ? `
                <p class="text-sm panel-text-secondary mt-2">
                    ${item.description}
                </p>
                ` : ''}
            </div>
            
            <!-- Pricing -->
            <div class="panel-section rounded-lg p-4">
                <h4 class="font-medium panel-text-primary mb-3 flex items-center">
                    <i data-lucide="dollar-sign" class="w-4 h-4 mr-2"></i>
                    Pricing
                </h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="panel-text-secondary">Price:</span>
                        <div class="font-medium text-green-600 dark:text-green-400">
                            ${item.price ? '$' + parseFloat(item.price).toFixed(2) : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <span class="panel-text-secondary">Cost:</span>
                        <div class="font-medium panel-text-primary">
                            ${item.cost ? '$' + parseFloat(item.cost).toFixed(2) : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <span class="panel-text-secondary">Margin:</span>
                        <div class="font-medium panel-text-primary">
                            ${item.profit_margin_percent ? item.profit_margin_percent.toFixed(1) + '%' : 'N/A'}
                        </div>
                    </div>
                    <div>
                        <span class="panel-text-secondary">Markup:</span>
                        <div class="font-medium panel-text-primary">
                            ${item.profit_markup_percent ? item.profit_markup_percent.toFixed(1) + '%' : 'N/A'}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory -->
            <div class="panel-section rounded-lg p-4">
                <h4 class="font-medium panel-text-primary mb-3 flex items-center">
                    <i data-lucide="package" class="w-4 h-4 mr-2"></i>
                    Inventory
                </h4>
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${item.total_qty || 0}</div>
                    <div class="text-sm panel-text-secondary">Total Stock</div>
                </div>
                
                <!-- Location breakdown -->
                <div class="space-y-2">
                    ${renderLocationStock(item)}
                </div>
            </div>
            
            <!-- Vendor Info -->
            <div class="panel-section rounded-lg p-4">
                <h4 class="font-medium panel-text-primary mb-3 flex items-center">
                    <i data-lucide="building-2" class="w-4 h-4 mr-2"></i>
                    Vendor
                </h4>
                <div class="space-y-2 text-sm">
                    <div>
                        <span class="panel-text-secondary">Vendor:</span>
                        <div class="font-medium panel-text-primary">${item.vendor_name || 'N/A'}</div>
                    </div>
                    <div>
                        <span class="panel-text-secondary">Vendor Code:</span>
                        <div class="font-medium panel-text-primary">${item.vendor_code || 'N/A'}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderLocationStock(item) {
    const locations = [
        {name: 'Aubrey', code: 'A', qty: item.aubrey_qty || 0},
        {name: 'Bridgefarmer', code: 'BF', qty: item.bridgefarmer_qty || 0},
        {name: 'Building', code: 'B', qty: item.building_qty || 0},
        {name: 'FloMo', code: 'F', qty: item.flomo_qty || 0},
        {name: 'Justin', code: 'J', qty: item.justin_qty || 0},
        {name: 'Quinlan', code: 'Q', qty: item.quinlan_qty || 0},
        {name: 'Terrell', code: 'T', qty: item.terrell_qty || 0}
    ];
    
    return locations.map(loc => `
        <div class="flex justify-between items-center py-1 panel-border-b">
            <span class="text-sm panel-text-secondary">
                ${loc.name} (${loc.code})
            </span>
            <span class="font-medium ${loc.qty > 0 ? 'text-green-600 dark:text-green-400' : 'panel-text-secondary'}">
                ${loc.qty}
            </span>
        </div>
    `).join('');
}

// Function to show mobile filters and hide desktop filters
function showMobileFilters() {
    console.log("Showing mobile filters");
    const mobileFilters = document.querySelector('.mobile-filters');
    const desktopFilters = document.querySelector('.desktop-filters');
    
    if (mobileFilters) mobileFilters.style.display = 'block';
    if (desktopFilters) desktopFilters.style.display = 'none';
}

// Function to show desktop filters and hide mobile filters
function showDesktopFilters() {
    console.log("Showing desktop filters");
    const mobileFilters = document.querySelector('.mobile-filters');
    const desktopFilters = document.querySelector('.desktop-filters');
    
    if (mobileFilters) mobileFilters.style.display = 'none';
    if (desktopFilters) desktopFilters.style.display = 'block';
}

// Handle window resize to maintain proper behavior
let resizeTimeout;
window.addEventListener('resize', function() {
    // Debounce resize events
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
        console.log("Window resized to:", window.innerWidth);
        
        // Update column visibility based on new screen size
        updateColumnVisibilityForScreenSize();
        
        // Close slide panel if user switches to desktop (unless in dev mobile mode)
        if (window.innerWidth >= 768 && !isMobileView) {
            closeItemSlidePanel();
        }
    }, 150);
});

// Reinitialize icons when content updates
document.addEventListener('htmx:afterSwap', function() {
    lucide.createIcons();
});
</script>
{% endblock %} 