2024-12-29 13:52:15,065 [INFO] nytex_dashboard - Creating database engine with URL: postgresql+asyncpg://postgres:postgres@localhost:5432/square_data_sync
2024-12-29 13:53:52,401 [INFO] nytex_dashboard - Loading dashboard index page
2024-12-29 13:53:52,402 [INFO] nytex_dashboard - Fetching fresh seasonal sales...
2024-12-29 13:53:52,402 [DEBUG] nytex_dashboard - Opening database session
2024-12-29 13:53:52,402 [INFO] nytex_dashboard - Checking for active season on date: 2024-12-29
2024-12-29 13:53:52,405 [DEBUG] nytex_dashboard - Executing query to find active season for date: 2024-12-29
2024-12-29 13:53:52,472 [DEBUG] nytex_dashboard - Query result: <app.models.operating_season.OperatingSeason object at 0x10f3a55d0>
2024-12-29 13:53:52,472 [INFO] nytex_dashboard - Found active season: New Years Eve (2024-12-20 to 2025-01-01)
2024-12-29 13:53:52,473 [DEBUG] nytex_dashboard - Closed database session
2024-12-29 13:53:52,473 [DEBUG] nytex_dashboard - Opening database session
2024-12-29 13:53:52,473 [INFO] nytex_dashboard - Fetching sales for season: New Years Eve (2024-12-20 to 2025-01-01)
2024-12-29 13:53:52,482 [ERROR] nytex_dashboard - Error fetching seasonal sales: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: syntax error at or near "day"
[SQL: SELECT date_series.order_date, coalesce(count(distinct(orders.id)), $1::INTEGER) AS transaction_count, coalesce(sum(orders.total_amount), $2::INTEGER) AS total 
FROM (SELECT generate_series($3::DATE, $4::DATE, 1 day) AS order_date) AS date_series LEFT OUTER JOIN orders ON date(orders.order_date AT TIME ZONE $5::VARCHAR) = date_series.order_date GROUP BY date_series.order_date ORDER BY date_series.order_date]
[parameters: (0, 0, datetime.date(2024, 12, 20), datetime.date(2025, 1, 1), 'America/Chicago')]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 510, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 756, in _prepare
    prepared_stmt = await self._connection.prepare(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 636, in prepare
    return await self._prepare(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 654, in _prepare
    stmt = await self._get_statement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 433, in _get_statement
    statement = await self._protocol.prepare(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 166, in prepare
asyncpg.exceptions.PostgresSyntaxError: syntax error at or near "day"

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 941, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 568, in execute
    self._adapt_connection.await_(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 546, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 497, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 780, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.PostgresSyntaxError'>: syntax error at or near "day"

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/services/season_service.py", line 44, in get_seasonal_sales
    result = await self.session.execute(stmt)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 461, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2362, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2247, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 305, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 941, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 568, in execute
    self._adapt_connection.await_(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 546, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 497, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 780, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.PostgresSyntaxError'>: syntax error at or near "day"
[SQL: SELECT date_series.order_date, coalesce(count(distinct(orders.id)), $1::INTEGER) AS transaction_count, coalesce(sum(orders.total_amount), $2::INTEGER) AS total 
FROM (SELECT generate_series($3::DATE, $4::DATE, 1 day) AS order_date) AS date_series LEFT OUTER JOIN orders ON date(orders.order_date AT TIME ZONE $5::VARCHAR) = date_series.order_date GROUP BY date_series.order_date ORDER BY date_series.order_date]
[parameters: (0, 0, datetime.date(2024, 12, 20), datetime.date(2025, 1, 1), 'America/Chicago')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2024-12-29 13:53:52,498 [DEBUG] nytex_dashboard - Closed database session
2024-12-29 13:53:52,635 [INFO] nytex_dashboard - Loading metrics page
2024-12-29 13:53:52,635 [INFO] nytex_dashboard - Fetching fresh metrics from Square API...
2024-12-29 13:53:52,636 [INFO] nytex_dashboard - Initializing Square client with environment: production
2024-12-29 13:53:52,636 [INFO] nytex_dashboard - Fetching today's sales metrics...
2024-12-29 13:53:52,904 [INFO] nytex_dashboard - Found 7 active locations
2024-12-29 13:53:52,905 [INFO] nytex_dashboard - Fetching orders between 2024-12-29 00:00:00-06:00 and 2024-12-29 23:59:59.999999-06:00 for 7 locations
2024-12-29 13:53:53,317 [INFO] nytex_dashboard - Found 24 orders across all locations
2024-12-29 13:53:53,317 [INFO] nytex_dashboard - Total sales across all locations: $1584.38
2024-12-29 13:53:53,318 [INFO] nytex_dashboard - Fetching fresh seasonal sales...
2024-12-29 13:53:53,318 [DEBUG] nytex_dashboard - Opening database session
2024-12-29 13:53:53,319 [INFO] nytex_dashboard - Checking for active season on date: 2024-12-29
2024-12-29 13:53:53,319 [DEBUG] nytex_dashboard - Executing query to find active season for date: 2024-12-29
2024-12-29 13:53:53,321 [DEBUG] nytex_dashboard - Closed database session
2024-12-29 13:53:53,321 [ERROR] nytex_dashboard - Error loading metrics: Task <Task pending name='Task-48' coro=<AsyncToSync.main_wrap() running at /Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asgiref/sync.py:331> cb=[_run_until_complete_cb() at /usr/local/Cellar/python@3.11/3.11.10/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py:181]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/routes/dashboard.py", line 62, in get_metrics
    sales_data, current_season = await get_cached_seasonal_sales()
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/routes/dashboard.py", line 23, in get_cached_seasonal_sales
    current_season = await get_current_season()
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/services/current_season.py", line 20, in get_current_season
    result = await session.execute(stmt)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 461, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2362, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2247, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 305, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2358, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 941, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 568, in execute
    self._adapt_connection.await_(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 504, in _prepare_and_execute
    await adapt_connection._start_transaction()
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 833, in _start_transaction
    self._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 782, in _handle_exception
    raise error
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 831, in _start_transaction
    await self._transaction.start()
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/transaction.py", line 146, in start
    await self._connection.execute(query)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 350, in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 374, in query
RuntimeError: Task <Task pending name='Task-48' coro=<AsyncToSync.main_wrap() running at /Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asgiref/sync.py:331> cb=[_run_until_complete_cb() at /usr/local/Cellar/python@3.11/3.11.10/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py:181]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
2024-12-29 13:53:57,138 [INFO] nytex_dashboard - Loading dashboard index page
2024-12-29 13:53:57,139 [INFO] nytex_dashboard - Fetching fresh seasonal sales...
2024-12-29 13:53:57,139 [DEBUG] nytex_dashboard - Opening database session
2024-12-29 13:53:57,139 [INFO] nytex_dashboard - Checking for active season on date: 2024-12-29
2024-12-29 13:53:57,140 [DEBUG] nytex_dashboard - Executing query to find active season for date: 2024-12-29
2024-12-29 13:53:57,143 [DEBUG] nytex_dashboard - Closed database session
2024-12-29 13:55:05,644 [INFO] nytex_dashboard - Creating database engine with URL: postgresql+asyncpg://postgres:postgres@localhost:5432/square_data_sync
2024-12-29 13:55:09,568 [INFO] nytex_dashboard - Loading dashboard index page
2024-12-29 13:55:09,569 [INFO] nytex_dashboard - Fetching fresh seasonal sales...
2024-12-29 13:55:09,569 [DEBUG] nytex_dashboard - Opening database session
2024-12-29 13:55:09,569 [INFO] nytex_dashboard - Checking for active season on date: 2024-12-29
2024-12-29 13:55:09,575 [DEBUG] nytex_dashboard - Executing query to find active season for date: 2024-12-29
2024-12-29 13:55:09,651 [DEBUG] nytex_dashboard - Query result: <app.models.operating_season.OperatingSeason object at 0x10f0a5450>
2024-12-29 13:55:09,651 [INFO] nytex_dashboard - Found active season: New Years Eve (2024-12-20 to 2025-01-01)
2024-12-29 13:55:09,652 [DEBUG] nytex_dashboard - Closed database session
2024-12-29 13:55:09,652 [DEBUG] nytex_dashboard - Opening database session
2024-12-29 13:55:09,652 [INFO] nytex_dashboard - Fetching sales for season: New Years Eve (2024-12-20 to 2025-01-01)
2024-12-29 13:55:09,666 [ERROR] nytex_dashboard - Error fetching seasonal sales: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column orders.order_date does not exist
[SQL: SELECT date_series.order_date, coalesce(count(distinct(orders.id)), $1::INTEGER) AS transaction_count, coalesce(sum(orders.total_amount), $2::INTEGER) AS total 
FROM (SELECT generate_series($3::DATE, $4::DATE, '1 day') AS order_date) AS date_series LEFT OUTER JOIN orders ON date(orders.order_date AT TIME ZONE $5::VARCHAR) = date_series.order_date GROUP BY date_series.order_date ORDER BY date_series.order_date]
[parameters: (0, 0, datetime.date(2024, 12, 20), datetime.date(2025, 1, 1), 'America/Chicago')]
(Background on this error at: https://sqlalche.me/e/20/f405)
Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 510, in _prepare_and_execute
    prepared_stmt, attributes = await adapt_connection._prepare(
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 756, in _prepare
    prepared_stmt = await self._connection.prepare(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 636, in prepare
    return await self._prepare(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 654, in _prepare
    stmt = await self._get_statement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 433, in _get_statement
    statement = await self._protocol.prepare(
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 166, in prepare
asyncpg.exceptions.UndefinedColumnError: column orders.order_date does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 941, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 568, in execute
    self._adapt_connection.await_(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 546, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 497, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 780, in _handle_exception
    raise translated_error from error
sqlalchemy.dialects.postgresql.asyncpg.AsyncAdapt_asyncpg_dbapi.ProgrammingError: <class 'asyncpg.exceptions.UndefinedColumnError'>: column orders.order_date does not exist

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/services/season_service.py", line 44, in get_seasonal_sales
    result = await self.session.execute(stmt)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 461, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2362, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2247, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 305, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 941, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 568, in execute
    self._adapt_connection.await_(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 546, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 497, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 780, in _handle_exception
    raise translated_error from error
sqlalchemy.exc.ProgrammingError: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedColumnError'>: column orders.order_date does not exist
[SQL: SELECT date_series.order_date, coalesce(count(distinct(orders.id)), $1::INTEGER) AS transaction_count, coalesce(sum(orders.total_amount), $2::INTEGER) AS total 
FROM (SELECT generate_series($3::DATE, $4::DATE, '1 day') AS order_date) AS date_series LEFT OUTER JOIN orders ON date(orders.order_date AT TIME ZONE $5::VARCHAR) = date_series.order_date GROUP BY date_series.order_date ORDER BY date_series.order_date]
[parameters: (0, 0, datetime.date(2024, 12, 20), datetime.date(2025, 1, 1), 'America/Chicago')]
(Background on this error at: https://sqlalche.me/e/20/f405)
2024-12-29 13:55:09,680 [DEBUG] nytex_dashboard - Closed database session
2024-12-29 13:55:09,844 [INFO] nytex_dashboard - Loading metrics page
2024-12-29 13:55:09,844 [INFO] nytex_dashboard - Fetching fresh metrics from Square API...
2024-12-29 13:55:09,844 [INFO] nytex_dashboard - Initializing Square client with environment: production
2024-12-29 13:55:09,846 [INFO] nytex_dashboard - Fetching today's sales metrics...
2024-12-29 13:55:10,166 [INFO] nytex_dashboard - Found 7 active locations
2024-12-29 13:55:10,167 [INFO] nytex_dashboard - Fetching orders between 2024-12-29 00:00:00-06:00 and 2024-12-29 23:59:59.999999-06:00 for 7 locations
2024-12-29 13:55:10,674 [INFO] nytex_dashboard - Found 25 orders across all locations
2024-12-29 13:55:10,675 [INFO] nytex_dashboard - Total sales across all locations: $1594.11
2024-12-29 13:55:10,676 [INFO] nytex_dashboard - Fetching fresh seasonal sales...
2024-12-29 13:55:10,676 [DEBUG] nytex_dashboard - Opening database session
2024-12-29 13:55:10,676 [INFO] nytex_dashboard - Checking for active season on date: 2024-12-29
2024-12-29 13:55:10,676 [DEBUG] nytex_dashboard - Executing query to find active season for date: 2024-12-29
2024-12-29 13:55:10,677 [DEBUG] nytex_dashboard - Closed database session
2024-12-29 13:55:10,677 [ERROR] nytex_dashboard - Error loading metrics: Task <Task pending name='Task-33' coro=<AsyncToSync.main_wrap() running at /Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asgiref/sync.py:331> cb=[_run_until_complete_cb() at /usr/local/Cellar/python@3.11/3.11.10/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py:181]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
Traceback (most recent call last):
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/routes/dashboard.py", line 62, in get_metrics
    sales_data, current_season = await get_cached_seasonal_sales()
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/routes/dashboard.py", line 23, in get_cached_seasonal_sales
    current_season = await get_current_season()
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/app/services/current_season.py", line 20, in get_current_season
    result = await session.execute(stmt)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 461, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2362, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2247, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 305, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2358, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 941, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 568, in execute
    self._adapt_connection.await_(
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 504, in _prepare_and_execute
    await adapt_connection._start_transaction()
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 833, in _start_transaction
    self._handle_exception(error)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 782, in _handle_exception
    raise error
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 831, in _start_transaction
    await self._transaction.start()
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/transaction.py", line 146, in start
    await self._connection.execute(query)
  File "/Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asyncpg/connection.py", line 350, in execute
    result = await self._protocol.query(query, timeout)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 374, in query
RuntimeError: Task <Task pending name='Task-33' coro=<AsyncToSync.main_wrap() running at /Users/joshgoble/code/nytexfireworks/nytex_dashboard/.venv/lib/python3.11/site-packages/asgiref/sync.py:331> cb=[_run_until_complete_cb() at /usr/local/Cellar/python@3.11/3.11.10/Frameworks/Python.framework/Versions/3.11/lib/python3.11/asyncio/base_events.py:181]> got Future <Future pending cb=[Protocol._on_waiter_completed()]> attached to a different loop
